# 数据库设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 文档状态 | 已完成 |
| 创建日期 | 2026-02-28 |
| 最后更新 | 2026-02-28 |

---

## 1. 数据库选型

### 1.1 选型分析

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| SQLite | 轻量、免安装、单文件、跨平台 | 并发写入性能一般 | 采用 |
| LevelDB | 高性能KV存储 | 不支持SQL查询 | 不采用 |
| IndexedDB | 浏览器原生支持 | API复杂、查询能力弱 | 不采用 |

### 1.2 选型结论

采用 **SQLite** 作为本地数据库，理由：

1. **零配置**：无需安装额外数据库服务
2. **单文件**：便于备份和迁移
3. **跨平台**：Windows/macOS/Linux完美支持
4. **功能完整**：支持标准SQL、事务、索引
5. **稳定可靠**：经过数十年验证的成熟方案

### 1.3 技术实现

在 Tauri 环境中使用 `tauri-plugin-sql` 或 `better-sqlite3`（通过 Node.js）访问 SQLite。

---

## 2. 概念模型设计

### 2.1 核心实体关系图 (E-R)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          E-R 概念模型                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐         ┌──────────────┐                         │
│  │   Template   │◄────────│   Document   │                         │
│  │   (模板)     │  使用    │   (文档)     │                         │
│  └──────────────┘         └──────────────┘                         │
│                                  │                                  │
│                                  │ 包含                             │
│                                  ▼                                  │
│                           ┌──────────────┐                         │
│                           │   Chart      │                         │
│                           │   (图表)     │                         │
│                           └──────────────┘                         │
│                                                                     │
│  ┌──────────────┐         ┌──────────────┐                         │
│  │  AISession   │────────►│   Message    │                         │
│  │  (AI会话)    │  包含    │   (消息)     │                         │
│  └──────────────┘         └──────────────┘                         │
│                                                                     │
│  ┌──────────────┐         ┌──────────────┐                         │
│  │ AuditRecord  │────────►│   Document   │                         │
│  │ (审核记录)   │  审核    │   (文档)     │                         │
│  └──────────────┘         └──────────────┘                         │
│                                                                     │
│  ┌──────────────┐                                                   │
│  │  UserConfig  │                                                   │
│  │  (用户配置)  │                                                   │
│  └──────────────┘                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 实体说明

| 实体 | 说明 | 主要属性 |
|------|------|----------|
| Document | 公文文档 | 标题、内容、类型、状态、环境标识 |
| Template | 公文模板 | 名称、分类、格式定义、示例内容 |
| Chart | 图表 | 类型、数据、样式、关联文档 |
| AISession | AI对话会话 | 环境、AI提供商、开始时间 |
| Message | 对话消息 | 角色、内容、时间戳 |
| AuditRecord | 审核记录 | 文档ID、审核结果、问题列表 |
| UserConfig | 用户配置 | 配置项、配置值 |

---

## 3. 物理模型设计

### 3.1 文档表 (documents)

```sql
CREATE TABLE documents (
    id              TEXT PRIMARY KEY,           -- UUID
    title           TEXT NOT NULL,              -- 文档标题
    content         TEXT,                       -- 文档内容(JSON/HTML)
    content_text    TEXT,                       -- 纯文本内容(用于搜索)
    doc_type        TEXT NOT NULL,              -- 文档类型
    template_id     TEXT,                       -- 关联模板ID
    status          TEXT DEFAULT 'draft',       -- 状态: draft/reviewing/final
    environment     TEXT NOT NULL,              -- 创建环境: public/private
    word_count      INTEGER DEFAULT 0,          -- 字数统计
    tags            TEXT,                       -- 标签(JSON数组)
    metadata        TEXT,                       -- 元数据(JSON)
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    deleted_at      DATETIME,                   -- 软删除标记
    
    FOREIGN KEY (template_id) REFERENCES templates(id)
);

-- 索引
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_doc_type ON documents(doc_type);
CREATE INDEX idx_documents_environment ON documents(environment);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_deleted_at ON documents(deleted_at);

-- 全文搜索索引
CREATE VIRTUAL TABLE documents_fts USING fts5(
    title,
    content_text,
    content='documents',
    content_rowid='rowid'
);
```

### 3.2 模板表 (templates)

```sql
CREATE TABLE templates (
    id              TEXT PRIMARY KEY,           -- UUID
    name            TEXT NOT NULL,              -- 模板名称
    category        TEXT NOT NULL,              -- 分类: notice/report/request/reply/letter/minutes
    description     TEXT,                       -- 模板描述
    content         TEXT NOT NULL,              -- 模板内容(JSON)
    format_config   TEXT,                       -- 格式配置(JSON)
    example_content TEXT,                       -- 示例内容
    is_builtin      INTEGER DEFAULT 0,          -- 是否内置模板
    is_favorite     INTEGER DEFAULT 0,          -- 是否收藏
    use_count       INTEGER DEFAULT 0,          -- 使用次数
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_is_builtin ON templates(is_builtin);
CREATE INDEX idx_templates_is_favorite ON templates(is_favorite);
```

### 3.3 图表表 (charts)

```sql
CREATE TABLE charts (
    id              TEXT PRIMARY KEY,           -- UUID
    document_id     TEXT,                       -- 关联文档ID
    name            TEXT,                       -- 图表名称
    chart_type      TEXT NOT NULL,              -- 类型: flowchart/orgchart/mindmap/timeline
    data            TEXT NOT NULL,              -- 图表数据(JSON)
    style           TEXT,                       -- 样式配置(JSON)
    svg_content     TEXT,                       -- SVG渲染结果
    position        TEXT,                       -- 在文档中的位置(JSON)
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_charts_document_id ON charts(document_id);
CREATE INDEX idx_charts_chart_type ON charts(chart_type);
```

### 3.4 AI会话表 (ai_sessions)

```sql
CREATE TABLE ai_sessions (
    id              TEXT PRIMARY KEY,           -- UUID
    document_id     TEXT,                       -- 关联文档ID(可选)
    environment     TEXT NOT NULL,              -- 环境: public/private
    ai_provider     TEXT NOT NULL,              -- AI提供商
    ai_model        TEXT,                       -- 使用的模型
    session_type    TEXT NOT NULL,              -- 类型: generate/review/rewrite/chat
    token_used      INTEGER DEFAULT 0,          -- Token使用量
    started_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    ended_at        DATETIME,
    
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE SET NULL
);

-- 索引
CREATE INDEX idx_ai_sessions_document_id ON ai_sessions(document_id);
CREATE INDEX idx_ai_sessions_environment ON ai_sessions(environment);
CREATE INDEX idx_ai_sessions_session_type ON ai_sessions(session_type);
CREATE INDEX idx_ai_sessions_started_at ON ai_sessions(started_at);
```

### 3.5 消息表 (messages)

```sql
CREATE TABLE messages (
    id              TEXT PRIMARY KEY,           -- UUID
    session_id      TEXT NOT NULL,              -- 所属会话ID
    role            TEXT NOT NULL,              -- 角色: system/user/assistant
    content         TEXT NOT NULL,              -- 消息内容
    token_count     INTEGER DEFAULT 0,          -- Token数量
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (session_id) REFERENCES ai_sessions(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_messages_session_id ON messages(session_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
```

### 3.6 审核记录表 (audit_records)

```sql
CREATE TABLE audit_records (
    id              TEXT PRIMARY KEY,           -- UUID
    document_id     TEXT NOT NULL,              -- 文档ID
    session_id      TEXT,                       -- AI会话ID
    audit_type      TEXT NOT NULL,              -- 审核类型: content/format/all
    passed          INTEGER NOT NULL,           -- 是否通过: 0/1
    score           INTEGER,                    -- 得分 0-100
    issues          TEXT,                       -- 问题列表(JSON)
    suggestions     TEXT,                       -- 修改建议(JSON)
    raw_response    TEXT,                       -- AI原始响应
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (session_id) REFERENCES ai_sessions(id) ON DELETE SET NULL
);

-- 索引
CREATE INDEX idx_audit_records_document_id ON audit_records(document_id);
CREATE INDEX idx_audit_records_passed ON audit_records(passed);
CREATE INDEX idx_audit_records_created_at ON audit_records(created_at);
```

### 3.7 用户配置表 (user_configs)

```sql
CREATE TABLE user_configs (
    key             TEXT PRIMARY KEY,           -- 配置键
    value           TEXT NOT NULL,              -- 配置值(JSON)
    category        TEXT NOT NULL,              -- 分类: general/ai/security/ui
    encrypted       INTEGER DEFAULT 0,          -- 是否加密存储
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_user_configs_category ON user_configs(category);
```

### 3.8 审计日志表 (audit_logs)

```sql
CREATE TABLE audit_logs (
    id              TEXT PRIMARY KEY,           -- UUID
    event_type      TEXT NOT NULL,              -- 事件类型
    environment     TEXT NOT NULL,              -- 环境
    details         TEXT,                       -- 详情(JSON)
    user_id         TEXT,                       -- 用户ID(预留)
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_audit_logs_event_type ON audit_logs(event_type);
CREATE INDEX idx_audit_logs_environment ON audit_logs(environment);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);

-- 定期清理旧日志(保留90天)
-- 由应用层定时任务执行
```

---

## 4. 数据模型详解

### 4.1 文档内容结构 (Document.content)

```typescript
interface DocumentContent {
  // 文档版本
  version: string;
  
  // 块级内容
  blocks: ContentBlock[];
  
  // 文档元信息
  meta: {
    format: 'official' | 'custom';
    pageSize: 'A4' | 'A3';
    margins: { top: number; bottom: number; left: number; right: number };
  };
}

interface ContentBlock {
  id: string;
  type: 'title' | 'subtitle' | 'paragraph' | 'list' | 'table' | 'chart' | 'signature';
  content: string | object;
  style?: Record<string, any>;
}
```

### 4.2 模板格式配置 (Template.format_config)

```typescript
interface TemplateFormatConfig {
  // 标题格式
  title: {
    font: string;        // 方正小标宋
    size: number;        // 22pt
    align: 'center' | 'left';
    bold: boolean;
  };
  
  // 正文格式
  body: {
    font: string;        // 仿宋_GB2312
    size: number;        // 16pt
    lineHeight: number;  // 28pt
    firstIndent: number; // 2字符
  };
  
  // 页面设置
  page: {
    size: 'A4' | 'A3';
    margins: {
      top: number;       // 37mm
      bottom: number;    // 35mm
      left: number;      // 28mm
      right: number;     // 26mm
    };
  };
  
  // 落款格式
  signature: {
    align: 'right';
    dateFormat: 'chinese' | 'standard';
  };
}
```

### 4.3 图表数据结构 (Chart.data)

```typescript
// 流程图数据
interface FlowchartData {
  nodes: {
    id: string;
    label: string;
    type: 'start' | 'end' | 'process' | 'decision' | 'io';
    position: { x: number; y: number };
  }[];
  edges: {
    id: string;
    source: string;
    target: string;
    label?: string;
  }[];
}

// 组织架构图数据
interface OrgchartData {
  nodes: {
    id: string;
    name: string;
    title?: string;
    parentId?: string;
  }[];
}

// 思维导图数据
interface MindmapData {
  root: {
    id: string;
    text: string;
    children?: MindmapData['root'][];
  };
}
```

### 4.4 审核问题结构 (AuditRecord.issues)

```typescript
interface AuditIssue {
  id: string;
  type: 'format' | 'content' | 'logic' | 'language' | 'policy';
  severity: 'high' | 'medium' | 'low';
  description: string;
  position?: {
    blockId?: string;
    startOffset?: number;
    endOffset?: number;
  };
  suggestion: string;
  autoFixable: boolean;
}
```

---

## 5. 索引设计

### 5.1 索引策略

| 表 | 索引 | 类型 | 用途 |
|----|------|------|------|
| documents | idx_documents_status | B-Tree | 按状态筛选 |
| documents | idx_documents_environment | B-Tree | 按环境筛选 |
| documents | idx_documents_created_at | B-Tree | 时间排序 |
| documents | documents_fts | FTS5 | 全文搜索 |
| templates | idx_templates_category | B-Tree | 按分类筛选 |
| ai_sessions | idx_ai_sessions_environment | B-Tree | 按环境统计 |
| audit_logs | idx_audit_logs_created_at | B-Tree | 日志查询 |

### 5.2 全文搜索

使用 SQLite FTS5 扩展实现文档全文搜索：

```sql
-- 搜索文档
SELECT d.* 
FROM documents d
JOIN documents_fts fts ON d.rowid = fts.rowid
WHERE documents_fts MATCH '公文 通知'
ORDER BY rank;
```

---

## 6. 数据迁移

### 6.1 版本管理

```sql
-- 版本表
CREATE TABLE schema_versions (
    version         INTEGER PRIMARY KEY,
    description     TEXT,
    applied_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 迁移脚本示例

```typescript
// migrations/001_initial.ts
export const up = async (db: Database) => {
  await db.exec(`
    CREATE TABLE documents (...);
    CREATE TABLE templates (...);
    -- ... 其他表
  `);
  
  await db.run('INSERT INTO schema_versions (version, description) VALUES (1, "Initial schema")');
};

export const down = async (db: Database) => {
  await db.exec(`
    DROP TABLE IF EXISTS documents;
    DROP TABLE IF EXISTS templates;
    -- ...
  `);
};
```

### 6.3 数据备份

```typescript
// 备份数据库
async function backupDatabase(): Promise<string> {
  const dbPath = getDbPath();
  const backupPath = `${dbPath}.backup.${Date.now()}`;
  
  await fs.copyFile(dbPath, backupPath);
  
  return backupPath;
}

// 恢复数据库
async function restoreDatabase(backupPath: string): Promise<void> {
  const dbPath = getDbPath();
  
  // 关闭当前连接
  await closeDatabase();
  
  // 恢复
  await fs.copyFile(backupPath, dbPath);
  
  // 重新打开
  await openDatabase();
}
```

---

## 7. 数据访问层

### 7.1 Repository 模式

```typescript
// 基础 Repository
abstract class BaseRepository<T> {
  protected db: Database;
  protected tableName: string;
  
  constructor(db: Database, tableName: string) {
    this.db = db;
    this.tableName = tableName;
  }
  
  async findById(id: string): Promise<T | null> {
    return this.db.get(
      `SELECT * FROM ${this.tableName} WHERE id = ?`,
      [id]
    );
  }
  
  async findAll(options?: FindOptions): Promise<T[]> {
    let sql = `SELECT * FROM ${this.tableName}`;
    const params: any[] = [];
    
    if (options?.where) {
      // 构建WHERE子句...
    }
    
    if (options?.orderBy) {
      sql += ` ORDER BY ${options.orderBy}`;
    }
    
    if (options?.limit) {
      sql += ` LIMIT ?`;
      params.push(options.limit);
    }
    
    return this.db.all(sql, params);
  }
  
  async create(entity: Partial<T>): Promise<T> {
    // 生成INSERT语句...
  }
  
  async update(id: string, entity: Partial<T>): Promise<T> {
    // 生成UPDATE语句...
  }
  
  async delete(id: string): Promise<void> {
    await this.db.run(
      `UPDATE ${this.tableName} SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?`,
      [id]
    );
  }
}

// 文档 Repository
class DocumentRepository extends BaseRepository<Document> {
  constructor(db: Database) {
    super(db, 'documents');
  }
  
  async findByEnvironment(env: 'public' | 'private'): Promise<Document[]> {
    return this.db.all(
      'SELECT * FROM documents WHERE environment = ? AND deleted_at IS NULL ORDER BY updated_at DESC',
      [env]
    );
  }
  
  async search(query: string): Promise<Document[]> {
    return this.db.all(`
      SELECT d.* FROM documents d
      JOIN documents_fts fts ON d.rowid = fts.rowid
      WHERE documents_fts MATCH ? AND d.deleted_at IS NULL
      ORDER BY rank
    `, [query]);
  }
  
  async getRecentDocuments(limit: number = 10): Promise<Document[]> {
    return this.db.all(
      'SELECT * FROM documents WHERE deleted_at IS NULL ORDER BY updated_at DESC LIMIT ?',
      [limit]
    );
  }
}
```

### 7.2 事务支持

```typescript
// 事务执行器
async function withTransaction<T>(
  db: Database,
  fn: () => Promise<T>
): Promise<T> {
  await db.run('BEGIN TRANSACTION');
  
  try {
    const result = await fn();
    await db.run('COMMIT');
    return result;
  } catch (error) {
    await db.run('ROLLBACK');
    throw error;
  }
}

// 使用示例
await withTransaction(db, async () => {
  await documentRepo.create(document);
  await auditRepo.create(auditRecord);
});
```

---

## 8. 性能优化

### 8.1 查询优化建议

| 场景 | 优化策略 |
|------|----------|
| 列表查询 | 使用分页，限制返回数量 |
| 搜索查询 | 使用FTS5全文索引 |
| 统计查询 | 创建汇总表或视图 |
| 频繁更新 | 批量更新，减少事务 |

### 8.2 SQLite 优化配置

```sql
-- 性能优化PRAGMA
PRAGMA journal_mode = WAL;          -- 使用WAL模式，提升并发
PRAGMA synchronous = NORMAL;        -- 平衡性能和安全
PRAGMA cache_size = -64000;         -- 64MB缓存
PRAGMA temp_store = MEMORY;         -- 临时表存内存
PRAGMA mmap_size = 268435456;       -- 256MB内存映射
```

---

## 9. 附录

### 9.1 数据库文件位置

| 平台 | 位置 |
|------|------|
| Windows | `%APPDATA%\RedInk\data\redink.db` |
| macOS | `~/Library/Application Support/RedInk/data/redink.db` |
| Linux | `~/.config/RedInk/data/redink.db` |

### 9.2 表清单

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | documents | 文档表 |
| 2 | templates | 模板表 |
| 3 | charts | 图表表 |
| 4 | ai_sessions | AI会话表 |
| 5 | messages | 消息表 |
| 6 | audit_records | 审核记录表 |
| 7 | user_configs | 用户配置表 |
| 8 | audit_logs | 审计日志表 |
| 9 | schema_versions | 版本管理表 |

---

*文档结束*
