# 数据模型说明

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 文档状态 | 已完成 |
| 创建日期 | 2026-02-28 |
| 最后更新 | 2026-02-28 |

---

## 1. 文档模型 (Document)

### 1.1 模型说明

Document 是系统的核心数据模型，用于存储用户创建的公文文档。

### 1.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 文档唯一标识 |
| title | string | 是 | - | 文档标题 |
| content | JSON | 否 | null | 文档结构化内容 |
| content_text | string | 否 | null | 纯文本内容（用于搜索） |
| doc_type | string | 是 | - | 文档类型 |
| template_id | string | 否 | null | 关联模板ID |
| status | enum | 否 | 'draft' | 文档状态 |
| environment | enum | 是 | - | 创建时的环境 |
| word_count | number | 否 | 0 | 字数统计 |
| tags | JSON | 否 | [] | 标签数组 |
| metadata | JSON | 否 | {} | 扩展元数据 |
| created_at | datetime | 是 | now | 创建时间 |
| updated_at | datetime | 是 | now | 更新时间 |
| deleted_at | datetime | 否 | null | 软删除时间 |

### 1.3 枚举值说明

**doc_type (文档类型)**
| 值 | 说明 |
|----|------|
| notice | 通知 |
| report | 报告 |
| request | 请示 |
| reply | 批复 |
| letter | 函 |
| minutes | 会议纪要 |
| other | 其他 |

**status (文档状态)**
| 值 | 说明 |
|----|------|
| draft | 草稿 |
| reviewing | 审核中 |
| final | 定稿 |
| archived | 已归档 |

**environment (环境)**
| 值 | 说明 |
|----|------|
| public | 公网环境创建 |
| private | 私域环境创建 |

### 1.4 content 字段结构

```typescript
interface DocumentContent {
  version: string;        // 内容版本号，如 "1.0"
  blocks: ContentBlock[]; // 内容块数组
  meta: {
    format: 'official' | 'custom';
    pageSize: 'A4' | 'A3';
    margins: {
      top: number;
      bottom: number;
      left: number;
      right: number;
    };
  };
}

interface ContentBlock {
  id: string;                   // 块ID
  type: BlockType;              // 块类型
  content: string | object;     // 块内容
  style?: Record<string, any>;  // 样式配置
  children?: ContentBlock[];    // 子块（用于嵌套结构）
}

type BlockType = 
  | 'title'       // 标题
  | 'subtitle'    // 副标题
  | 'paragraph'   // 段落
  | 'heading1'    // 一级标题
  | 'heading2'    // 二级标题
  | 'heading3'    // 三级标题
  | 'list'        // 列表
  | 'table'       // 表格
  | 'chart'       // 图表
  | 'signature'   // 落款
  | 'attachment'; // 附件说明
```

### 1.5 示例数据

```json
{
  "id": "doc_abc123",
  "title": "关于召开年度工作总结会议的通知",
  "content": {
    "version": "1.0",
    "blocks": [
      {
        "id": "blk_001",
        "type": "title",
        "content": "关于召开年度工作总结会议的通知"
      },
      {
        "id": "blk_002",
        "type": "paragraph",
        "content": "各部门、各单位：..."
      }
    ],
    "meta": {
      "format": "official",
      "pageSize": "A4",
      "margins": { "top": 37, "bottom": 35, "left": 28, "right": 26 }
    }
  },
  "doc_type": "notice",
  "template_id": "tpl_notice_001",
  "status": "draft",
  "environment": "private",
  "word_count": 856,
  "tags": ["年度工作", "会议通知"],
  "created_at": "2026-02-28T10:00:00Z",
  "updated_at": "2026-02-28T14:30:00Z"
}
```

---

## 2. 模板模型 (Template)

### 2.1 模型说明

Template 用于存储公文模板，包括系统内置模板和用户自定义模板。

### 2.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 模板唯一标识 |
| name | string | 是 | - | 模板名称 |
| category | enum | 是 | - | 模板分类 |
| description | string | 否 | null | 模板描述 |
| content | JSON | 是 | - | 模板内容结构 |
| format_config | JSON | 否 | null | 格式配置 |
| example_content | string | 否 | null | 示例内容 |
| is_builtin | boolean | 否 | false | 是否内置模板 |
| is_favorite | boolean | 否 | false | 是否收藏 |
| use_count | number | 否 | 0 | 使用次数 |
| created_at | datetime | 是 | now | 创建时间 |
| updated_at | datetime | 是 | now | 更新时间 |

### 2.3 category 枚举值

| 值 | 说明 | 典型用途 |
|----|------|----------|
| notice | 通知 | 会议通知、工作通知 |
| report | 报告 | 工作报告、调研报告 |
| request | 请示 | 请示、申请 |
| reply | 批复 | 对请示的答复 |
| letter | 函 | 商洽函、复函 |
| minutes | 会议纪要 | 会议记录整理 |
| summary | 总结 | 工作总结、年度总结 |
| plan | 计划 | 工作计划、项目计划 |

### 2.4 format_config 结构

```typescript
interface TemplateFormatConfig {
  // 标题格式
  title: {
    font: string;           // 字体，如 "方正小标宋简体"
    fontSize: number;       // 字号(pt)，如 22
    fontWeight: 'normal' | 'bold';
    align: 'left' | 'center' | 'right';
    color?: string;
  };
  
  // 正文格式
  body: {
    font: string;           // 字体，如 "仿宋_GB2312"
    fontSize: number;       // 字号(pt)，如 16
    lineHeight: number;     // 行高(pt)，如 28
    firstLineIndent: number; // 首行缩进(字符)，如 2
    paragraphSpacing: number; // 段间距(pt)
  };
  
  // 页面设置
  page: {
    size: 'A4' | 'A3' | 'Letter';
    orientation: 'portrait' | 'landscape';
    margins: {
      top: number;          // 上边距(mm)
      bottom: number;       // 下边距(mm)
      left: number;         // 左边距(mm)
      right: number;        // 右边距(mm)
    };
  };
  
  // 页眉页脚
  header?: {
    content: string;
    font: string;
    fontSize: number;
  };
  
  footer?: {
    showPageNumber: boolean;
    format: 'arabic' | 'chinese';
    position: 'center' | 'right';
  };
  
  // 落款格式
  signature: {
    align: 'right' | 'center';
    dateFormat: 'chinese' | 'standard';  // 二〇二六年 vs 2026年
    spacing: number;  // 与正文间距
  };
}
```

### 2.5 示例数据

```json
{
  "id": "tpl_notice_001",
  "name": "通用通知模板",
  "category": "notice",
  "description": "适用于一般性工作通知的标准模板",
  "content": {
    "blocks": [
      { "type": "title", "placeholder": "关于XXX的通知" },
      { "type": "recipient", "placeholder": "各部门、各单位：" },
      { "type": "paragraph", "placeholder": "正文内容..." },
      { "type": "signature", "placeholder": "发文单位" },
      { "type": "date", "placeholder": "XXXX年XX月XX日" }
    ]
  },
  "format_config": {
    "title": {
      "font": "方正小标宋简体",
      "fontSize": 22,
      "fontWeight": "bold",
      "align": "center"
    },
    "body": {
      "font": "仿宋_GB2312",
      "fontSize": 16,
      "lineHeight": 28,
      "firstLineIndent": 2
    },
    "page": {
      "size": "A4",
      "orientation": "portrait",
      "margins": { "top": 37, "bottom": 35, "left": 28, "right": 26 }
    },
    "signature": {
      "align": "right",
      "dateFormat": "chinese"
    }
  },
  "is_builtin": true,
  "use_count": 156,
  "created_at": "2026-01-01T00:00:00Z"
}
```

---

## 3. AI会话模型 (AISession)

### 3.1 模型说明

AISession 记录每次AI交互的会话信息，用于统计和追溯。

### 3.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 会话唯一标识 |
| document_id | string | 否 | null | 关联文档ID |
| environment | enum | 是 | - | 会话环境 |
| ai_provider | string | 是 | - | AI提供商 |
| ai_model | string | 否 | null | 使用的模型 |
| session_type | enum | 是 | - | 会话类型 |
| token_used | number | 否 | 0 | Token使用量 |
| started_at | datetime | 是 | now | 开始时间 |
| ended_at | datetime | 否 | null | 结束时间 |

### 3.3 枚举值说明

**session_type (会话类型)**
| 值 | 说明 |
|----|------|
| generate | 内容生成 |
| review | 内容审核 |
| rewrite | 内容改写 |
| chat | 自由对话 |
| chart | 图表生成 |

**ai_provider (AI提供商)**
| 值 | 环境 | 说明 |
|----|------|------|
| openai | 公网 | OpenAI GPT系列 |
| claude | 公网 | Anthropic Claude |
| qwen | 公网 | 阿里通义千问 |
| wenxin | 公网 | 百度文心一言 |
| spark | 公网 | 讯飞星火 |
| ollama | 私域 | Ollama本地服务 |
| lmstudio | 私域 | LM Studio |
| custom | 私域 | 自定义本地服务 |

### 3.4 示例数据

```json
{
  "id": "sess_xyz789",
  "document_id": "doc_abc123",
  "environment": "private",
  "ai_provider": "ollama",
  "ai_model": "qwen:7b",
  "session_type": "generate",
  "token_used": 2048,
  "started_at": "2026-02-28T14:00:00Z",
  "ended_at": "2026-02-28T14:00:35Z"
}
```

---

## 4. 消息模型 (Message)

### 4.1 模型说明

Message 存储AI会话中的每条消息，支持完整的对话历史记录。

### 4.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 消息唯一标识 |
| session_id | string | 是 | - | 所属会话ID |
| role | enum | 是 | - | 消息角色 |
| content | string | 是 | - | 消息内容 |
| token_count | number | 否 | 0 | Token数量 |
| created_at | datetime | 是 | now | 创建时间 |

### 4.3 role 枚举值

| 值 | 说明 |
|----|------|
| system | 系统提示词 |
| user | 用户输入 |
| assistant | AI响应 |

### 4.4 示例数据

```json
{
  "id": "msg_001",
  "session_id": "sess_xyz789",
  "role": "user",
  "content": "请帮我写一份关于团建活动的通知",
  "token_count": 15,
  "created_at": "2026-02-28T14:00:00Z"
}
```

---

## 5. 审核记录模型 (AuditRecord)

### 5.1 模型说明

AuditRecord 存储AI对文档的审核结果，便于查看历史审核记录。

### 5.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 记录唯一标识 |
| document_id | string | 是 | - | 文档ID |
| session_id | string | 否 | null | AI会话ID |
| audit_type | enum | 是 | - | 审核类型 |
| passed | boolean | 是 | - | 是否通过 |
| score | number | 否 | null | 得分(0-100) |
| issues | JSON | 否 | [] | 问题列表 |
| suggestions | JSON | 否 | [] | 修改建议 |
| raw_response | string | 否 | null | AI原始响应 |
| created_at | datetime | 是 | now | 创建时间 |

### 5.3 audit_type 枚举值

| 值 | 说明 |
|----|------|
| content | 内容审核 |
| format | 格式审核 |
| all | 全面审核 |

### 5.4 issues 字段结构

```typescript
interface AuditIssue {
  id: string;                    // 问题ID
  type: IssueType;               // 问题类型
  severity: 'high' | 'medium' | 'low'; // 严重程度
  description: string;           // 问题描述
  position?: {                   // 问题位置
    blockId?: string;
    startOffset?: number;
    endOffset?: number;
    paragraph?: number;
  };
  originalText?: string;         // 原始文本
  suggestion: string;            // 修改建议
  autoFixable: boolean;          // 是否可自动修复
}

type IssueType = 
  | 'format'    // 格式问题
  | 'content'   // 内容问题
  | 'logic'     // 逻辑问题
  | 'language'  // 语言问题
  | 'policy';   // 政策合规问题
```

### 5.5 示例数据

```json
{
  "id": "audit_001",
  "document_id": "doc_abc123",
  "session_id": "sess_xyz789",
  "audit_type": "all",
  "passed": false,
  "score": 75,
  "issues": [
    {
      "id": "iss_001",
      "type": "format",
      "severity": "medium",
      "description": "标题字号不符合规范，应为二号字",
      "position": { "blockId": "blk_001" },
      "suggestion": "将标题字号调整为二号(22pt)",
      "autoFixable": true
    },
    {
      "id": "iss_002",
      "type": "language",
      "severity": "low",
      "description": "存在口语化表达",
      "position": { "paragraph": 3, "startOffset": 45, "endOffset": 52 },
      "originalText": "搞一下",
      "suggestion": "建议改为"开展"或"组织"",
      "autoFixable": false
    }
  ],
  "suggestions": [
    "建议检查文档整体格式是否符合GB/T 9704-2012标准",
    "部分段落表述可进一步精简"
  ],
  "created_at": "2026-02-28T15:00:00Z"
}
```

---

## 6. 图表模型 (Chart)

### 6.1 模型说明

Chart 存储文档中的图表数据，支持多种图表类型。

### 6.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 图表唯一标识 |
| document_id | string | 否 | null | 关联文档ID |
| name | string | 否 | null | 图表名称 |
| chart_type | enum | 是 | - | 图表类型 |
| data | JSON | 是 | - | 图表数据 |
| style | JSON | 否 | {} | 样式配置 |
| svg_content | string | 否 | null | SVG渲染结果 |
| position | JSON | 否 | null | 文档中位置 |
| created_at | datetime | 是 | now | 创建时间 |
| updated_at | datetime | 是 | now | 更新时间 |

### 6.3 chart_type 枚举值

| 值 | 说明 | 典型用途 |
|----|------|----------|
| flowchart | 流程图 | 工作流程、审批流程 |
| orgchart | 组织架构图 | 部门结构、人员组织 |
| mindmap | 思维导图 | 内容规划、要点梳理 |
| timeline | 时间轴 | 项目进度、历史沿革 |
| relation | 关系图 | 人物关系、业务关联 |
| sequence | 时序图 | 流程交互 |

### 6.4 data 字段结构（按类型）

#### 流程图 (flowchart)

```typescript
interface FlowchartData {
  nodes: {
    id: string;
    label: string;
    type: 'start' | 'end' | 'process' | 'decision' | 'io';
    position: { x: number; y: number };
  }[];
  edges: {
    id: string;
    source: string;
    target: string;
    label?: string;
    type?: 'default' | 'yes' | 'no';
  }[];
}
```

#### 组织架构图 (orgchart)

```typescript
interface OrgchartData {
  nodes: {
    id: string;
    name: string;
    title?: string;
    department?: string;
    parentId?: string;
    level?: number;
  }[];
}
```

#### 思维导图 (mindmap)

```typescript
interface MindmapData {
  root: MindmapNode;
}

interface MindmapNode {
  id: string;
  text: string;
  children?: MindmapNode[];
  collapsed?: boolean;
  style?: {
    backgroundColor?: string;
    textColor?: string;
  };
}
```

### 6.5 示例数据

```json
{
  "id": "chart_001",
  "document_id": "doc_abc123",
  "name": "项目审批流程",
  "chart_type": "flowchart",
  "data": {
    "nodes": [
      { "id": "n1", "label": "提交申请", "type": "start", "position": { "x": 100, "y": 50 } },
      { "id": "n2", "label": "部门审核", "type": "process", "position": { "x": 100, "y": 150 } },
      { "id": "n3", "label": "是否通过?", "type": "decision", "position": { "x": 100, "y": 250 } },
      { "id": "n4", "label": "完成", "type": "end", "position": { "x": 100, "y": 350 } }
    ],
    "edges": [
      { "id": "e1", "source": "n1", "target": "n2" },
      { "id": "e2", "source": "n2", "target": "n3" },
      { "id": "e3", "source": "n3", "target": "n4", "label": "是", "type": "yes" }
    ]
  },
  "style": {
    "theme": "default",
    "nodeStyle": { "borderRadius": 4 }
  },
  "position": { "blockId": "blk_005", "width": 600, "height": 400 },
  "created_at": "2026-02-28T16:00:00Z"
}
```

---

## 7. 用户配置模型 (UserConfig)

### 7.1 模型说明

UserConfig 存储用户的各类配置信息，采用 Key-Value 结构。

### 7.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| key | string | 是 | - | 配置键（主键） |
| value | JSON | 是 | - | 配置值 |
| category | enum | 是 | - | 配置分类 |
| encrypted | boolean | 否 | false | 是否加密存储 |
| updated_at | datetime | 是 | now | 更新时间 |

### 7.3 category 枚举值

| 值 | 说明 | 典型配置项 |
|----|------|------------|
| general | 通用设置 | 语言、主题、自动保存间隔 |
| ai | AI设置 | 默认模型、温度参数 |
| security | 安全设置 | 敏感检测开关、默认环境 |
| ui | 界面设置 | 布局偏好、字体大小 |
| export | 导出设置 | 默认格式、输出路径 |

### 7.4 常用配置键

| 键 | 分类 | 说明 | 值类型 |
|----|------|------|--------|
| default_environment | security | 默认环境 | string |
| sensitive_detection_enabled | security | 敏感检测 | boolean |
| ai_default_provider_public | ai | 默认公网AI | string |
| ai_default_provider_private | ai | 默认私域AI | string |
| ai_temperature | ai | 默认温度 | number |
| ui_theme | ui | 主题模式 | string |
| ui_sidebar_collapsed | ui | 侧边栏折叠 | boolean |
| export_default_format | export | 默认导出格式 | string |
| auto_save_interval | general | 自动保存间隔 | number |

### 7.5 示例数据

```json
[
  {
    "key": "default_environment",
    "value": "private",
    "category": "security",
    "encrypted": false,
    "updated_at": "2026-02-28T10:00:00Z"
  },
  {
    "key": "ai_default_provider_private",
    "value": { "provider": "ollama", "model": "qwen:7b" },
    "category": "ai",
    "encrypted": false,
    "updated_at": "2026-02-28T10:00:00Z"
  },
  {
    "key": "api_key_openai",
    "value": "encrypted_value_here",
    "category": "ai",
    "encrypted": true,
    "updated_at": "2026-02-28T10:00:00Z"
  }
]
```

---

## 8. 审计日志模型 (AuditLog)

### 8.1 模型说明

AuditLog 记录系统关键操作日志，用于安全审计和问题追溯。

### 8.2 字段定义

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string | 是 | UUID | 日志唯一标识 |
| event_type | enum | 是 | - | 事件类型 |
| environment | enum | 是 | - | 当前环境 |
| details | JSON | 否 | {} | 事件详情 |
| user_id | string | 否 | null | 用户ID（预留） |
| created_at | datetime | 是 | now | 创建时间 |

### 8.3 event_type 枚举值

| 值 | 说明 |
|----|------|
| ENV_SWITCH | 环境切换 |
| AI_REQUEST | AI请求 |
| AI_CONFIG_CHANGE | AI配置变更 |
| DOC_CREATE | 创建文档 |
| DOC_OPEN | 打开文档 |
| DOC_SAVE | 保存文档 |
| DOC_EXPORT | 导出文档 |
| DOC_DELETE | 删除文档 |
| SENSITIVE_DETECTED | 检测到敏感信息 |
| SENSITIVE_BLOCKED | 敏感信息被阻止 |
| NETWORK_BLOCKED | 网络请求被阻止 |
| APP_START | 应用启动 |
| APP_EXIT | 应用退出 |
| ERROR | 错误事件 |

### 8.4 示例数据

```json
{
  "id": "log_001",
  "event_type": "ENV_SWITCH",
  "environment": "public",
  "details": {
    "from": "private",
    "to": "public",
    "userConfirmed": true
  },
  "created_at": "2026-02-28T14:30:00Z"
}
```

---

## 9. 模型关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         数据模型关系                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐                                                   │
│  │   Template   │                                                   │
│  └──────┬───────┘                                                   │
│         │ 1                                                         │
│         │                                                           │
│         │ 使用                                                       │
│         │                                                           │
│         │ n                                                         │
│  ┌──────▼───────┐         ┌──────────────┐                         │
│  │   Document   │─────────│    Chart     │                         │
│  └──────┬───────┘  1   n  └──────────────┘                         │
│         │                                                           │
│         │ 1                                                         │
│         │                                                           │
│    ┌────┴────┬────────────┐                                        │
│    │         │            │                                         │
│    │ n       │ n          │ n                                       │
│    ▼         ▼            ▼                                         │
│ ┌─────────┐ ┌──────────┐ ┌──────────────┐                          │
│ │AISession│ │AuditRecord│ │  AuditLog   │                          │
│ └────┬────┘ └──────────┘ └──────────────┘                          │
│      │                                                              │
│      │ 1                                                            │
│      │                                                              │
│      │ n                                                            │
│ ┌────▼────┐                                                        │
│ │ Message │                                                        │
│ └─────────┘                                                        │
│                                                                     │
│  独立实体:                                                          │
│  ┌──────────────┐                                                   │
│  │  UserConfig  │ (Key-Value 配置存储)                              │
│  └──────────────┘                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

关系说明:
• Template 1:n Document  (一个模板可被多个文档使用)
• Document 1:n Chart     (一个文档可包含多个图表)
• Document 1:n AISession (一个文档可有多次AI会话)
• Document 1:n AuditRecord (一个文档可有多次审核记录)
• AISession 1:n Message  (一个会话包含多条消息)
```

---

*文档结束*
