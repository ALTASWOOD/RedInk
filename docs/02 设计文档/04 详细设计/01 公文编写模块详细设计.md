# 公文编写模块详细设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 文档状态 | 已完成 |
| 创建日期 | 2026-03-01 |
| 最后更新 | 2026-03-01 |

---

## 1. 模块概述

### 1.1 模块职责

公文编写模块是 RedInk 的核心业务模块，负责：

- 提供基于 TipTap 的富文本编辑器，支持公文格式排版
- 管理公文模板的浏览、选择、使用和自定义
- 集成 AI 辅助编写能力（内容生成、续写、改写）
- 管理素材库（常用短语、段落模板、图片素材）
- 实现文档的创建、编辑、保存、版本管理
- 实现自动保存与版本快照

### 1.2 模块边界

```
┌─────────────────────────────────────────────────────────────────────┐
│                       公文编写模块边界                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  输入                                                                │
│  ├─ 用户选择的模板                                                  │
│  ├─ 用户编辑的文本内容                                              │
│  ├─ AI生成/续写/改写请求                                            │
│  ├─ 素材插入请求                                                    │
│  └─ 格式调整指令                                                    │
│                                                                     │
│  输出                                                                │
│  ├─ 格式化的公文文档（JSON/HTML）                                   │
│  ├─ 文档元数据（字数、状态、版本）                                  │
│  └─ 导出请求（传递给导出模块）                                      │
│                                                                     │
│  依赖                                                                │
│  ├─ AI集成模块 (AIServiceManager)                                   │
│  ├─ 数据层 (DocumentRepository, TemplateRepository)                 │
│  ├─ 环境管理器 (EnvironmentManager)                                 │
│  └─ IPC通信层                                                       │
│                                                                     │
│  被依赖                                                              │
│  ├─ AI审核模块（获取文档内容进行审核）                              │
│  ├─ 文档导出模块（获取文档内容进行导出）                            │
│  └─ 图表绘制模块（图表插入到文档中）                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 类设计

### 2.1 类图

```
┌─────────────────────────────────────────────────────────────────────┐
│                            类图                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────┐       ┌─────────────────────┐             │
│  │   DocumentEditor    │       │  TemplateManager    │             │
│  │   (编辑器核心)       │       │  (模板管理器)        │             │
│  ├─────────────────────┤       ├─────────────────────┤             │
│  │ - editor: TipTapEditor│     │ - templates         │             │
│  │ - document: Document │       │ - categories        │             │
│  │ - formatConfig       │       ├─────────────────────┤             │
│  │ - autoSaveTimer      │       │ + getTemplates()    │             │
│  ├─────────────────────┤       │ + getByCategory()   │             │
│  │ + initialize()      │       │ + createCustom()    │             │
│  │ + loadDocument()    │       │ + importTemplate()  │             │
│  │ + save()            │       │ + exportTemplate()  │             │
│  │ + applyTemplate()   │       └─────────────────────┘             │
│  │ + insertContent()   │                                           │
│  │ + getContent()      │       ┌─────────────────────┐             │
│  │ + getWordCount()    │       │  MaterialManager    │             │
│  └─────────┬───────────┘       │  (素材管理器)        │             │
│            │                   ├─────────────────────┤             │
│            │ 使用              │ - phrases           │             │
│            ▼                   │ - paragraphs        │             │
│  ┌─────────────────────┐       │ - images            │             │
│  │  FormatEngine       │       ├─────────────────────┤             │
│  │  (格式引擎)          │       │ + searchMaterials() │             │
│  ├─────────────────────┤       │ + insertPhrase()    │             │
│  │ - formatRules       │       │ + insertParagraph() │             │
│  │ - activeConfig      │       │ + addCustom()       │             │
│  ├─────────────────────┤       └─────────────────────┘             │
│  │ + applyOfficialFmt()│                                           │
│  │ + validateFormat()  │       ┌─────────────────────┐             │
│  │ + getFormatConfig() │       │  VersionManager     │             │
│  │ + setTitleFormat()  │       │  (版本管理器)        │             │
│  │ + setBodyFormat()   │       ├─────────────────────┤             │
│  └─────────────────────┘       │ - versions          │             │
│                                │ - autoSaveInterval  │             │
│  ┌─────────────────────┐       ├─────────────────────┤             │
│  │  AIWritingAssistant │       │ + createVersion()   │             │
│  │  (AI写作助手)        │       │ + getVersions()     │             │
│  ├─────────────────────┤       │ + compareVersions() │             │
│  │ - aiService         │       │ + restoreVersion()  │             │
│  │ - promptManager     │       │ + startAutoSave()   │             │
│  ├─────────────────────┤       └─────────────────────┘             │
│  │ + generateContent() │                                           │
│  │ + continueWriting() │       ┌─────────────────────┐             │
│  │ + rewriteContent()  │       │  DocumentService    │             │
│  │ + generateMultiple()│       │  (文档服务-主进程)    │             │
│  └─────────────────────┘       ├─────────────────────┤             │
│                                │ - documentRepo      │             │
│                                │ - versionRepo       │             │
│                                ├─────────────────────┤             │
│                                │ + create()          │             │
│                                │ + save()            │             │
│                                │ + findById()        │             │
│                                │ + search()          │             │
│                                │ + delete()          │             │
│                                └─────────────────────┘             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心类定义

#### DocumentEditor（编辑器核心）

```typescript
/**
 * 公文编辑器核心类
 * 封装 TipTap 编辑器，提供公文编辑能力
 */
class DocumentEditor {
  private editor: Editor;                    // TipTap 编辑器实例
  private document: DocumentData | null;     // 当前文档数据
  private formatEngine: FormatEngine;        // 格式引擎
  private versionManager: VersionManager;    // 版本管理器
  private aiAssistant: AIWritingAssistant;   // AI写作助手
  private autoSaveTimer: NodeJS.Timer | null;
  private isDirty: boolean = false;          // 是否有未保存的修改

  constructor(config: EditorConfig) {
    this.formatEngine = new FormatEngine(config.formatConfig);
    this.versionManager = new VersionManager();
    this.aiAssistant = new AIWritingAssistant();
    this.editor = this.createEditor(config);
    this.autoSaveTimer = null;
  }

  /**
   * 创建 TipTap 编辑器实例
   */
  private createEditor(config: EditorConfig): Editor {
    return new Editor({
      extensions: [
        StarterKit,
        // 公文专用扩展
        OfficialDocumentHeading,    // 公文标题扩展
        OfficialDocumentParagraph,  // 公文段落扩展（首行缩进等）
        PageBreak,                  // 分页符
        TableExtension,             // 表格
        ImageExtension,             // 图片
        ChartPlaceholder,           // 图表占位符
        SignatureBlock,             // 落款区块
        // 协作扩展
        Placeholder.configure({ placeholder: '开始编辑公文内容...' }),
        CharacterCount,             // 字数统计
      ],
      content: config.initialContent || '',
      onUpdate: ({ editor }) => {
        this.isDirty = true;
        this.onContentUpdate(editor);
      }
    });
  }

  /**
   * 加载文档
   */
  async loadDocument(documentId: string): Promise<void> {
    const doc = await window.electronAPI.document.findById(documentId);
    if (!doc) throw new Error(`文档不存在: ${documentId}`);

    this.document = doc;
    this.editor.commands.setContent(JSON.parse(doc.content));
    this.formatEngine.applyConfig(JSON.parse(doc.metadata)?.formatConfig);
    this.isDirty = false;
    this.startAutoSave();
  }

  /**
   * 从模板创建新文档
   */
  async createFromTemplate(template: Template): Promise<DocumentData> {
    const formatConfig = JSON.parse(template.format_config);
    this.formatEngine.applyConfig(formatConfig);

    const content = JSON.parse(template.content);
    this.editor.commands.setContent(content);

    const doc: DocumentData = {
      id: generateUUID(),
      title: '未命名文档',
      content: template.content,
      doc_type: template.category,
      template_id: template.id,
      status: 'draft',
      environment: getCurrentEnvironment(),
      word_count: 0,
      metadata: JSON.stringify({ formatConfig }),
    };

    this.document = doc;
    await window.electronAPI.document.create(doc);
    this.startAutoSave();

    // 更新模板使用次数
    await window.electronAPI.template.incrementUseCount(template.id);

    return doc;
  }

  /**
   * 保存文档
   */
  async save(): Promise<void> {
    if (!this.document) return;

    const content = JSON.stringify(this.editor.getJSON());
    const contentText = this.editor.getText();

    this.document.content = content;
    this.document.content_text = contentText;
    this.document.word_count = this.getWordCount();
    this.document.updated_at = new Date().toISOString();

    await window.electronAPI.document.save(this.document);

    // 创建版本快照
    await this.versionManager.createVersion(this.document);

    this.isDirty = false;
  }

  /**
   * 获取字数统计
   */
  getWordCount(): number {
    return this.editor.storage.characterCount.characters();
  }

  /**
   * 在光标位置插入内容
   */
  insertContent(content: string, options?: InsertOptions): void {
    if (options?.asAIGenerated) {
      // AI生成的内容添加特殊标记
      this.editor.chain()
        .focus()
        .insertContent({
          type: 'paragraph',
          attrs: { 'data-ai-generated': true },
          content: [{ type: 'text', text: content }]
        })
        .run();
    } else {
      this.editor.chain().focus().insertContent(content).run();
    }
  }

  /**
   * 应用公文标准格式
   */
  applyOfficialFormat(): void {
    this.formatEngine.applyOfficialFormat(this.editor);
  }

  /**
   * 获取选中文本
   */
  getSelectedText(): string {
    const { from, to } = this.editor.state.selection;
    return this.editor.state.doc.textBetween(from, to);
  }

  /**
   * 替换选中文本
   */
  replaceSelection(newText: string): void {
    this.editor.chain().focus().deleteSelection().insertContent(newText).run();
  }

  /**
   * 启动自动保存
   */
  private startAutoSave(): void {
    if (this.autoSaveTimer) clearInterval(this.autoSaveTimer);
    this.autoSaveTimer = setInterval(async () => {
      if (this.isDirty) {
        await this.save();
      }
    }, 30000); // 30秒间隔
  }

  /**
   * 内容更新回调
   */
  private onContentUpdate(editor: Editor): void {
    // 通知状态管理层更新字数等信息
    useEditorStore.getState().setWordCount(
      editor.storage.characterCount.characters()
    );
  }

  /**
   * 销毁编辑器
   */
  destroy(): void {
    if (this.autoSaveTimer) clearInterval(this.autoSaveTimer);
    this.editor.destroy();
  }
}
```

#### FormatEngine（格式引擎）

```typescript
/**
 * 公文格式引擎
 * 负责公文格式的应用和校验
 */
class FormatEngine {
  private config: OfficialFormatConfig;

  constructor(config?: OfficialFormatConfig) {
    this.config = config || DEFAULT_OFFICIAL_FORMAT;
  }

  /**
   * 应用公文标准格式到编辑器
   */
  applyOfficialFormat(editor: Editor): void {
    const { doc } = editor.state;

    editor.chain()
      .selectAll()
      .run();

    // 遍历文档节点，按类型应用格式
    doc.descendants((node, pos) => {
      if (node.type.name === 'heading') {
        this.applyHeadingFormat(editor, node, pos);
      } else if (node.type.name === 'paragraph') {
        this.applyParagraphFormat(editor, node, pos);
      }
    });
  }

  /**
   * 应用标题格式
   */
  private applyHeadingFormat(editor: Editor, node: any, pos: number): void {
    const level = node.attrs.level;
    const config = level === 1 ? this.config.title : this.config.subtitle;

    editor.chain()
      .setNodeSelection(pos)
      .updateAttributes('heading', {
        fontFamily: config.font,
        fontSize: config.size,
        textAlign: config.align,
        fontWeight: config.bold ? 'bold' : 'normal',
      })
      .run();
  }

  /**
   * 应用正文格式
   */
  private applyParagraphFormat(editor: Editor, node: any, pos: number): void {
    editor.chain()
      .setNodeSelection(pos)
      .updateAttributes('paragraph', {
        fontFamily: this.config.body.font,
        fontSize: this.config.body.size,
        lineHeight: this.config.body.lineHeight,
        textIndent: `${this.config.body.firstIndent}em`,
      })
      .run();
  }

  /**
   * 校验文档格式是否符合公文规范
   */
  validateFormat(editor: Editor): FormatValidationResult {
    const issues: FormatIssue[] = [];
    const { doc } = editor.state;

    doc.descendants((node, pos) => {
      if (node.type.name === 'heading' && node.attrs.level === 1) {
        // 检查标题格式
        if (node.attrs.fontSize !== this.config.title.size) {
          issues.push({
            type: 'title_font_size',
            position: pos,
            expected: `${this.config.title.size}pt`,
            actual: `${node.attrs.fontSize || '未设置'}`,
            severity: 'high',
            autoFixable: true,
          });
        }
      }
      // ... 更多格式检查
    });

    return {
      passed: issues.filter(i => i.severity === 'high').length === 0,
      issues,
      score: Math.max(0, 100 - issues.length * 10),
    };
  }

  /**
   * 获取当前格式配置
   */
  getConfig(): OfficialFormatConfig {
    return { ...this.config };
  }

  /**
   * 更新格式配置
   */
  applyConfig(config: OfficialFormatConfig): void {
    this.config = { ...this.config, ...config };
  }
}
```

#### AIWritingAssistant（AI写作助手）

```typescript
/**
 * AI写作助手
 * 提供AI辅助编写功能
 */
class AIWritingAssistant {
  private aiService: AIServiceManager;
  private promptManager: PromptManager;

  constructor() {
    this.aiService = AIServiceManager.getInstance();
    this.promptManager = new PromptManager();
  }

  /**
   * 内容生成
   * 根据用户输入的要点生成公文初稿
   */
  async generateContent(
    request: ContentGenerateRequest,
    onChunk?: (chunk: string) => void
  ): Promise<string> {
    const systemPrompt = this.promptManager.getPrompt('generate', request.docType);
    const userPrompt = this.buildGeneratePrompt(request);

    if (onChunk) {
      // 流式生成
      let fullContent = '';
      await this.aiService.generateStream(
        { systemPrompt, userPrompt },
        {
          onChunk: (chunk) => {
            fullContent += chunk;
            onChunk(chunk);
          },
          onComplete: () => {},
          onError: (error) => { throw error; }
        }
      );
      return fullContent;
    } else {
      const response = await this.aiService.generate({ systemPrompt, userPrompt });
      return response.content;
    }
  }

  /**
   * 智能续写
   * 基于已有内容续写后续段落
   */
  async continueWriting(
    existingContent: string,
    cursorContext: string,
    onChunk?: (chunk: string) => void
  ): Promise<string> {
    const systemPrompt = this.promptManager.getPrompt('continue');
    const userPrompt = `已有内容:\n${existingContent}\n\n光标上下文:\n${cursorContext}\n\n请续写:`;

    if (onChunk) {
      let fullContent = '';
      await this.aiService.generateStream(
        { systemPrompt, userPrompt },
        {
          onChunk: (chunk) => {
            fullContent += chunk;
            onChunk(chunk);
          }
        }
      );
      return fullContent;
    } else {
      const response = await this.aiService.generate({ systemPrompt, userPrompt });
      return response.content;
    }
  }

  /**
   * 内容改写
   * 对选中内容进行润色、精简、扩展等改写
   */
  async rewriteContent(
    selectedText: string,
    instruction: RewriteInstruction,
    customInstruction?: string
  ): Promise<string> {
    const systemPrompt = this.promptManager.getPrompt('rewrite');
    const instructionText = instruction === 'custom'
      ? customInstruction!
      : REWRITE_INSTRUCTION_MAP[instruction];

    const userPrompt = `原文:\n${selectedText}\n\n改写要求: ${instructionText}`;

    const response = await this.aiService.generate({
      systemPrompt,
      userPrompt,
      options: { temperature: 0.5 }
    });

    return response.content;
  }

  /**
   * 多方案生成
   * 同一需求生成多个不同风格的版本
   */
  async generateMultipleVersions(
    request: ContentGenerateRequest,
    count: number = 3
  ): Promise<GeneratedVersion[]> {
    const systemPrompt = this.promptManager.getPrompt('generate', request.docType);
    const styles: ContentStyle[] = ['formal', 'concise', 'detailed'];

    const versions: GeneratedVersion[] = [];

    for (let i = 0; i < Math.min(count, styles.length); i++) {
      const userPrompt = this.buildGeneratePrompt({
        ...request,
        style: styles[i],
      });

      const response = await this.aiService.generate({
        systemPrompt,
        userPrompt,
        options: { temperature: 0.7 + i * 0.1 }
      });

      versions.push({
        id: generateUUID(),
        style: styles[i],
        styleName: STYLE_NAME_MAP[styles[i]],
        content: response.content,
        tokenUsage: response.usage,
      });
    }

    return versions;
  }

  /**
   * 构建生成提示词
   */
  private buildGeneratePrompt(request: ContentGenerateRequest): string {
    let prompt = `请生成一篇${DOC_TYPE_NAME_MAP[request.docType]}。\n\n`;

    if (request.recipient) {
      prompt += `接收对象: ${request.recipient}\n`;
    }

    prompt += `主题要点:\n`;
    request.keyPoints.forEach((point, index) => {
      prompt += `${index + 1}. ${point}\n`;
    });

    if (request.background) {
      prompt += `\n背景信息: ${request.background}\n`;
    }

    if (request.style) {
      prompt += `\n风格要求: ${STYLE_DESC_MAP[request.style]}\n`;
    }

    return prompt;
  }
}
```

---

## 3. 接口设计

### 3.1 编辑器对外接口

```typescript
/**
 * 编辑器对外接口（React Hook 形式）
 */
interface UseDocumentEditor {
  /** 编辑器实例 */
  editor: Editor | null;

  /** 当前文档 */
  document: DocumentData | null;

  /** 是否有未保存修改 */
  isDirty: boolean;

  /** 字数统计 */
  wordCount: number;

  /** 加载文档 */
  loadDocument: (id: string) => Promise<void>;

  /** 从模板创建 */
  createFromTemplate: (template: Template) => Promise<DocumentData>;

  /** 保存文档 */
  save: () => Promise<void>;

  /** 应用公文格式 */
  applyOfficialFormat: () => void;

  /** 获取选中文本 */
  getSelectedText: () => string;

  /** 插入内容 */
  insertContent: (content: string, options?: InsertOptions) => void;

  /** 替换选中内容 */
  replaceSelection: (newText: string) => void;
}
```

### 3.2 模板管理接口

```typescript
/**
 * 模板管理服务接口
 */
interface ITemplateService {
  /** 获取所有模板 */
  getTemplates(filter?: TemplateFilter): Promise<Template[]>;

  /** 按分类获取 */
  getByCategory(category: DocType): Promise<Template[]>;

  /** 获取单个模板 */
  getById(id: string): Promise<Template | null>;

  /** 创建自定义模板 */
  createCustom(template: CreateTemplateRequest): Promise<Template>;

  /** 更新模板 */
  update(id: string, updates: Partial<Template>): Promise<Template>;

  /** 删除模板（内置模板不可删除） */
  delete(id: string): Promise<void>;

  /** 导入模板 */
  importTemplate(filePath: string): Promise<Template>;

  /** 导出模板 */
  exportTemplate(id: string, targetPath: string): Promise<void>;

  /** 收藏/取消收藏 */
  toggleFavorite(id: string): Promise<boolean>;
}

/**
 * 模板筛选条件
 */
interface TemplateFilter {
  category?: DocType;
  isBuiltin?: boolean;
  isFavorite?: boolean;
  keyword?: string;
  orderBy?: 'name' | 'use_count' | 'updated_at';
  orderDir?: 'asc' | 'desc';
}
```

### 3.3 素材库接口

```typescript
/**
 * 素材库服务接口
 */
interface IMaterialService {
  /** 搜索素材（跨类型） */
  search(query: string): Promise<MaterialSearchResult>;

  /** 获取常用短语列表 */
  getPhrases(category?: PhraseCategory): Promise<Phrase[]>;

  /** 添加自定义短语 */
  addPhrase(phrase: CreatePhraseRequest): Promise<Phrase>;

  /** 获取段落模板列表 */
  getParagraphTemplates(docType?: DocType): Promise<ParagraphTemplate[]>;

  /** 添加段落模板 */
  addParagraphTemplate(template: CreateParagraphTemplateRequest): Promise<ParagraphTemplate>;

  /** 渲染段落模板（填充变量） */
  renderParagraphTemplate(templateId: string, variables: Record<string, string>): string;

  /** 获取图片素材 */
  getImages(category?: ImageCategory): Promise<ImageMaterial[]>;

  /** 上传图片 */
  uploadImage(file: File, category: ImageCategory): Promise<ImageMaterial>;

  /** 获取最近使用的素材 */
  getRecentMaterials(limit?: number): Promise<Material[]>;

  /** 获取推荐素材（根据当前公文类型） */
  getRecommendedMaterials(docType: DocType): Promise<Material[]>;
}
```

### 3.4 AI写作辅助接口

```typescript
/**
 * AI写作助手接口
 */
interface IAIWritingService {
  /** 生成公文内容 */
  generateContent(
    request: ContentGenerateRequest,
    onChunk?: (chunk: string) => void
  ): Promise<string>;

  /** 智能续写 */
  continueWriting(
    existingContent: string,
    cursorContext: string,
    onChunk?: (chunk: string) => void
  ): Promise<string>;

  /** 内容改写 */
  rewriteContent(
    selectedText: string,
    instruction: RewriteInstruction,
    customInstruction?: string
  ): Promise<string>;

  /** 多方案生成 */
  generateMultipleVersions(
    request: ContentGenerateRequest,
    count?: number
  ): Promise<GeneratedVersion[]>;
}

/**
 * 内容生成请求
 */
interface ContentGenerateRequest {
  docType: DocType;
  templateId?: string;
  keyPoints: string[];
  background?: string;
  recipient?: string;
  style?: ContentStyle;
  lengthPreference?: 'short' | 'medium' | 'long';
}

/**
 * 改写指令类型
 */
type RewriteInstruction = 'polish' | 'simplify' | 'expand' | 'formal' | 'custom';

/**
 * 生成的版本
 */
interface GeneratedVersion {
  id: string;
  style: ContentStyle;
  styleName: string;
  content: string;
  tokenUsage?: TokenUsage;
}
```

### 3.5 版本管理接口

```typescript
/**
 * 版本管理接口
 */
interface IVersionService {
  /** 创建版本快照 */
  createVersion(document: DocumentData): Promise<DocumentVersion>;

  /** 获取版本列表 */
  getVersions(documentId: string): Promise<DocumentVersion[]>;

  /** 对比两个版本 */
  compareVersions(versionId1: string, versionId2: string): Promise<VersionDiff>;

  /** 恢复到指定版本 */
  restoreVersion(versionId: string): Promise<DocumentData>;
}
```

### 3.6 IPC通信接口

```typescript
/**
 * 文档相关 IPC 通道定义
 */
interface DocumentIPC {
  /** 创建文档 */
  'document:create': (doc: DocumentData) => Promise<DocumentData>;

  /** 保存文档 */
  'document:save': (doc: DocumentData) => Promise<void>;

  /** 获取文档 */
  'document:findById': (id: string) => Promise<DocumentData | null>;

  /** 搜索文档 */
  'document:search': (query: string) => Promise<DocumentData[]>;

  /** 获取文档列表 */
  'document:list': (filter: DocumentFilter) => Promise<DocumentData[]>;

  /** 删除文档（软删除） */
  'document:delete': (id: string) => Promise<void>;

  /** 获取最近文档 */
  'document:recent': (limit: number) => Promise<DocumentData[]>;
}

/**
 * 模板相关 IPC 通道定义
 */
interface TemplateIPC {
  /** 获取模板列表 */
  'template:list': (filter: TemplateFilter) => Promise<Template[]>;

  /** 获取单个模板 */
  'template:findById': (id: string) => Promise<Template | null>;

  /** 创建模板 */
  'template:create': (template: CreateTemplateRequest) => Promise<Template>;

  /** 更新使用次数 */
  'template:incrementUseCount': (id: string) => Promise<void>;
}
```

---

## 4. 流程设计

### 4.1 新建公文流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        新建公文流程                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────┐                                                        │
│  │  开始   │                                                        │
│  └────┬────┘                                                        │
│       ▼                                                             │
│  ┌─────────────────────────────────────────┐                       │
│  │        用户点击"新建文档"                │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│  ┌─────────────────────────────────────────┐                       │
│  │        显示模板选择界面                   │                       │
│  │  (按分类展示：通知/报告/请示/批复/函/纪要)│                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│            ┌──────┴──────┐                                         │
│            │ 选择模板?   │                                         │
│            └──────┬──────┘                                         │
│         是 ┌──────┴──────┐ 否(空白文档)                             │
│            ▼             ▼                                         │
│  ┌─────────────────┐  ┌─────────────────┐                         │
│  │  加载模板内容   │  │  创建空白文档   │                         │
│  │  和格式配置     │  │  应用默认格式   │                         │
│  └────────┬────────┘  └────────┬────────┘                         │
│           └──────────┬─────────┘                                   │
│                      ▼                                             │
│  ┌─────────────────────────────────────────┐                       │
│  │        获取当前环境                       │                       │
│  │  设置文档environment字段                  │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│  ┌─────────────────────────────────────────┐                       │
│  │        在数据库创建文档记录               │                       │
│  │  状态: draft, 生成UUID                    │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│  ┌─────────────────────────────────────────┐                       │
│  │        初始化编辑器                       │                       │
│  │  加载内容, 启动自动保存                   │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│  ┌─────────────────────────────────────────┐                       │
│  │        显示编辑页面                       │                       │
│  │  编辑器 + AI面板 + 工具栏                 │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│            ┌─────────┐                                             │
│            │  结束   │                                             │
│            └─────────┘                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 AI辅助编写流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                      AI辅助编写流程                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户                    编辑器                     AI模块           │
│   │                         │                         │             │
│   │  1. 输入要点/选择操作    │                         │             │
│   │ ───────────────────────>│                         │             │
│   │                         │                         │             │
│   │                         │  2. 判断操作类型          │             │
│   │                         │  ─────────┐             │             │
│   │                         │  <────────┘             │             │
│   │                         │  (生成/续写/改写)        │             │
│   │                         │                         │             │
│   │                         │  3. 构建Prompt           │             │
│   │                         │  包含模板信息+上下文       │             │
│   │                         │ ───────────────────────>│             │
│   │                         │                         │             │
│   │  4. 显示"生成中..."      │                         │             │
│   │ <───────────────────────│                         │             │
│   │                         │                         │             │
│   │                         │  5. 流式返回生成内容       │             │
│   │                         │ <───────────────────────│             │
│   │                         │                         │             │
│   │  6. 实时显示生成内容      │                         │             │
│   │ <───────────────────────│                         │             │
│   │                         │                         │             │
│   │  7. 生成完成              │                         │             │
│   │ <───────────────────────│                         │             │
│   │                         │                         │             │
│   │  8. 用户选择操作          │                         │             │
│   │  [采纳] [修改] [重新生成] │                         │             │
│   │ ───────────────────────>│                         │             │
│   │                         │                         │             │
│   │                         │  9. 插入/替换内容        │             │
│   │                         │  标记为AI生成             │             │
│   │                         │  ─────────┐             │             │
│   │                         │  <────────┘             │             │
│   │                         │                         │             │
│   │  10. 显示更新后的文档     │                         │             │
│   │ <───────────────────────│                         │             │
│   │                         │                         │             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 素材插入流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                       素材插入流程                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────┐                                                        │
│  │  开始   │                                                        │
│  └────┬────┘                                                        │
│       ▼                                                             │
│  ┌─────────────────────────────────────────┐                       │
│  │  用户在素材库面板搜索/浏览素材           │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│            ┌──────┴──────┐                                         │
│            │  素材类型?  │                                         │
│            └──────┬──────┘                                         │
│      ┌───────────┼───────────┐                                     │
│      ▼           ▼           ▼                                     │
│  ┌────────┐ ┌────────┐ ┌────────┐                                 │
│  │ 短语   │ │段落模板 │ │ 图片   │                                 │
│  └───┬────┘ └───┬────┘ └───┬────┘                                 │
│      │          │          │                                       │
│      ▼          ▼          ▼                                       │
│  ┌────────┐ ┌────────────┐ ┌────────────┐                         │
│  │直接插入│ │弹出变量填充│ │调整尺寸后  │                         │
│  │到光标处│ │对话框      │ │插入到光标处│                         │
│  └───┬────┘ └───┬────────┘ └───┬────────┘                         │
│      │          │              │                                   │
│      │          ▼              │                                   │
│      │   ┌──────────────┐     │                                   │
│      │   │用户填充变量值│     │                                   │
│      │   │(如单位名、日期)│    │                                   │
│      │   └──────┬───────┘     │                                   │
│      │          ▼              │                                   │
│      │   ┌──────────────┐     │                                   │
│      │   │渲染段落内容  │     │                                   │
│      │   │替换变量占位符│     │                                   │
│      │   └──────┬───────┘     │                                   │
│      │          │              │                                   │
│      └──────────┼──────────────┘                                   │
│                 ▼                                                   │
│  ┌─────────────────────────────────────────┐                       │
│  │  更新素材使用次数                         │                       │
│  │  记录到"最近使用"                         │                       │
│  └────────────────┬────────────────────────┘                       │
│                   ▼                                                 │
│            ┌─────────┐                                             │
│            │  结束   │                                             │
│            └─────────┘                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.4 文档自动保存与版本管理流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                   自动保存与版本管理流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  编辑器                    版本管理器                   数据库        │
│   │                            │                         │          │
│   │  [每30秒触发]               │                         │          │
│   │  1. 检查isDirty标记         │                         │          │
│   │  ─────────┐                │                         │          │
│   │  <────────┘                │                         │          │
│   │                            │                         │          │
│   │  2. 如果有修改，序列化内容    │                         │          │
│   │  ─────────┐                │                         │          │
│   │  <────────┘                │                         │          │
│   │                            │                         │          │
│   │  3. 保存到数据库             │                         │          │
│   │ ──────────────────────────────────────────────────>│          │
│   │                            │                         │          │
│   │  [每5分钟触发]               │                         │          │
│   │  4. 创建版本快照请求         │                         │          │
│   │ ──────────────────────────>│                         │          │
│   │                            │                         │          │
│   │                            │  5. 保存快照到版本表      │          │
│   │                            │ ───────────────────────>│          │
│   │                            │                         │          │
│   │                            │  6. 检查版本数量          │          │
│   │                            │  超过50个则清理最旧版本    │          │
│   │                            │ ───────────────────────>│          │
│   │                            │                         │          │
│   │  7. 更新保存状态显示         │                         │          │
│   │  ─────────┐                │                         │          │
│   │  <────────┘                │                         │          │
│   │  (状态栏显示"已保存")       │                         │          │
│   │                            │                         │          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据结构设计

### 5.1 文档数据结构

```typescript
/**
 * 文档数据
 */
interface DocumentData {
  id: string;
  title: string;
  content: string;              // JSON序列化的TipTap文档
  content_text?: string;        // 纯文本（用于搜索）
  doc_type: DocType;
  template_id?: string;
  status: 'draft' | 'reviewing' | 'final';
  environment: 'public' | 'private';
  word_count: number;
  tags?: string[];
  metadata?: string;            // JSON: { formatConfig, ... }
  created_at: string;
  updated_at: string;
  deleted_at?: string;
}

/**
 * 文档类型
 */
type DocType = 'notice' | 'report' | 'request' | 'reply' | 'letter' | 'minutes';

/**
 * 文档类型中文映射
 */
const DOC_TYPE_NAME_MAP: Record<DocType, string> = {
  notice: '通知',
  report: '报告',
  request: '请示',
  reply: '批复',
  letter: '函',
  minutes: '会议纪要',
};
```

### 5.2 公文格式配置

```typescript
/**
 * 公文格式标准配置
 */
interface OfficialFormatConfig {
  title: {
    font: string;          // 方正小标宋 / 黑体
    size: number;          // 22pt (二号)
    align: 'center' | 'left';
    bold: boolean;
    lineHeight: number;
  };
  subtitle: {
    font: string;          // 楷体_GB2312
    size: number;          // 16pt (三号)
    align: 'center';
    bold: boolean;
  };
  body: {
    font: string;          // 仿宋_GB2312
    size: number;          // 16pt (三号)
    lineHeight: number;    // 28pt 固定值
    firstIndent: number;   // 2字符
  };
  page: {
    size: 'A4';
    margins: {
      top: number;         // 37mm
      bottom: number;      // 35mm
      left: number;        // 28mm
      right: number;       // 26mm
    };
  };
  signature: {
    align: 'right';
    dateFormat: 'chinese' | 'standard';  // 二〇二六年三月一日 / 2026年3月1日
  };
  numbering: {
    level1: string;        // 一、二、三、
    level2: string;        // （一）（二）
    level3: string;        // 1. 2. 3.
    level4: string;        // （1）（2）
  };
}

/**
 * 默认公文格式配置
 */
const DEFAULT_OFFICIAL_FORMAT: OfficialFormatConfig = {
  title: {
    font: '方正小标宋',
    size: 22,
    align: 'center',
    bold: true,
    lineHeight: 32,
  },
  subtitle: {
    font: '楷体_GB2312',
    size: 16,
    align: 'center',
    bold: false,
  },
  body: {
    font: '仿宋_GB2312',
    size: 16,
    lineHeight: 28,
    firstIndent: 2,
  },
  page: {
    size: 'A4',
    margins: { top: 37, bottom: 35, left: 28, right: 26 },
  },
  signature: {
    align: 'right',
    dateFormat: 'chinese',
  },
  numbering: {
    level1: 'chinese',     // 一、二、三、
    level2: 'paren_chinese', // （一）（二）
    level3: 'arabic_dot',  // 1. 2. 3.
    level4: 'paren_arabic', // （1）（2）
  },
};
```

### 5.3 模板数据结构

```typescript
/**
 * 模板数据
 */
interface Template {
  id: string;
  name: string;
  category: DocType;
  description?: string;
  content: string;              // JSON: TipTap内容结构
  format_config: string;        // JSON: OfficialFormatConfig
  example_content?: string;
  is_builtin: boolean;
  is_favorite: boolean;
  use_count: number;
  created_at: string;
  updated_at: string;
}

/**
 * 创建模板请求
 */
interface CreateTemplateRequest {
  name: string;
  category: DocType;
  description?: string;
  content: string;
  format_config?: string;
  example_content?: string;
}
```

### 5.4 素材数据结构

```typescript
/**
 * 常用短语
 */
interface Phrase {
  id: string;
  content: string;
  category: PhraseCategory;
  tags?: string[];
  use_count: number;
  is_builtin: boolean;
  created_at: string;
}

type PhraseCategory = 'opening' | 'closing' | 'transition' | 'request' | 'reply' | 'notice';

/**
 * 段落模板
 */
interface ParagraphTemplate {
  id: string;
  name: string;
  content: string;             // 包含 {{变量名}} 占位符
  variables: ParagraphVariable[];
  doc_types: DocType[];        // 适用的公文类型
  use_count: number;
  created_at: string;
}

/**
 * 段落模板变量
 */
interface ParagraphVariable {
  name: string;
  label: string;
  type: 'text' | 'date' | 'number' | 'select';
  required: boolean;
  defaultValue?: string;
  options?: string[];          // type为select时的选项
}

/**
 * 图片素材
 */
interface ImageMaterial {
  id: string;
  name: string;
  category: ImageCategory;
  filePath: string;
  thumbnail: string;           // 缩略图Base64
  width: number;
  height: number;
  fileSize: number;
  created_at: string;
}

type ImageCategory = 'seal' | 'signature' | 'illustration' | 'icon';
```

### 5.5 版本数据结构

```typescript
/**
 * 文档版本
 */
interface DocumentVersion {
  id: string;
  document_id: string;
  version_number: number;
  content_snapshot: string;     // 完整内容快照
  word_count: number;
  change_description?: string;  // 变更说明
  created_at: string;
}

/**
 * 版本差异
 */
interface VersionDiff {
  version1: DocumentVersion;
  version2: DocumentVersion;
  additions: DiffBlock[];
  deletions: DiffBlock[];
  modifications: DiffBlock[];
  wordCountChange: number;
}

/**
 * 差异块
 */
interface DiffBlock {
  type: 'add' | 'delete' | 'modify';
  position: { start: number; end: number };
  oldContent?: string;
  newContent?: string;
}
```

---

## 6. 异常处理设计

### 6.1 异常类型

```typescript
/**
 * 编辑器错误基类
 */
class EditorError extends Error {
  constructor(
    message: string,
    public readonly code: EditorErrorCode,
    public readonly details?: Record<string, any>
  ) {
    super(message);
    this.name = 'EditorError';
  }
}

/**
 * 编辑器错误码
 */
enum EditorErrorCode {
  // 文档相关
  DOCUMENT_NOT_FOUND = 'DOCUMENT_NOT_FOUND',
  DOCUMENT_SAVE_FAILED = 'DOCUMENT_SAVE_FAILED',
  DOCUMENT_LOAD_FAILED = 'DOCUMENT_LOAD_FAILED',
  DOCUMENT_CORRUPTED = 'DOCUMENT_CORRUPTED',

  // 模板相关
  TEMPLATE_NOT_FOUND = 'TEMPLATE_NOT_FOUND',
  TEMPLATE_BUILTIN_DELETE = 'TEMPLATE_BUILTIN_DELETE',
  TEMPLATE_NAME_DUPLICATE = 'TEMPLATE_NAME_DUPLICATE',
  TEMPLATE_IMPORT_FAILED = 'TEMPLATE_IMPORT_FAILED',

  // 素材相关
  MATERIAL_UPLOAD_FAILED = 'MATERIAL_UPLOAD_FAILED',
  MATERIAL_SIZE_EXCEEDED = 'MATERIAL_SIZE_EXCEEDED',
  MATERIAL_FORMAT_INVALID = 'MATERIAL_FORMAT_INVALID',

  // 格式相关
  FORMAT_APPLY_FAILED = 'FORMAT_APPLY_FAILED',

  // AI相关
  AI_GENERATE_FAILED = 'AI_GENERATE_FAILED',
  AI_REWRITE_FAILED = 'AI_REWRITE_FAILED',
}
```

### 6.2 异常处理策略

| 异常类型 | 处理策略 | 用户提示 |
|----------|----------|----------|
| DOCUMENT_SAVE_FAILED | 自动重试3次，失败后提示用户手动保存 | "保存失败，请手动保存或检查存储空间" |
| DOCUMENT_LOAD_FAILED | 提示用户，提供恢复选项 | "文档加载失败，是否尝试恢复？" |
| DOCUMENT_CORRUPTED | 尝试从最近版本恢复 | "文档内容损坏，已恢复到最近版本" |
| TEMPLATE_BUILTIN_DELETE | 阻止操作 | "内置模板不可删除，您可以复制后修改" |
| TEMPLATE_NAME_DUPLICATE | 阻止操作 | "同分类下已存在同名模板" |
| MATERIAL_SIZE_EXCEEDED | 阻止上传 | "图片大小超过10MB限制" |
| AI_GENERATE_FAILED | 委托AI模块重试机制处理 | "内容生成失败，请稍后重试" |

### 6.3 自动恢复机制

```typescript
/**
 * 文档自动恢复
 */
class DocumentRecovery {
  /**
   * 尝试恢复损坏的文档
   */
  async attemptRecovery(documentId: string): Promise<RecoveryResult> {
    // 1. 尝试从最近版本恢复
    const latestVersion = await this.getLatestVersion(documentId);
    if (latestVersion) {
      return {
        success: true,
        method: 'version_restore',
        content: latestVersion.content_snapshot,
        message: `已恢复到 ${latestVersion.created_at} 的版本`,
      };
    }

    // 2. 尝试从自动保存缓存恢复
    const cachedContent = this.getAutoSaveCache(documentId);
    if (cachedContent) {
      return {
        success: true,
        method: 'autosave_cache',
        content: cachedContent,
        message: '已从自动保存缓存恢复',
      };
    }

    // 3. 无法恢复
    return {
      success: false,
      method: 'none',
      message: '无法自动恢复，文档内容可能已丢失',
    };
  }

  private async getLatestVersion(documentId: string): Promise<DocumentVersion | null> {
    const versions = await window.electronAPI.version.getVersions(documentId);
    return versions.length > 0 ? versions[0] : null;
  }

  private getAutoSaveCache(documentId: string): string | null {
    return sessionStorage.getItem(`autosave_${documentId}`);
  }
}
```

---

## 7. TipTap 扩展设计

### 7.1 公文标题扩展

```typescript
/**
 * 公文标题扩展
 * 支持公文标准标题格式
 */
const OfficialDocumentHeading = Heading.extend({
  addAttributes() {
    return {
      ...this.parent?.(),
      fontFamily: {
        default: '方正小标宋',
        parseHTML: element => element.style.fontFamily,
        renderHTML: attributes => ({
          style: `font-family: ${attributes.fontFamily}`,
        }),
      },
      fontSize: {
        default: '22pt',
        parseHTML: element => element.style.fontSize,
        renderHTML: attributes => ({
          style: `font-size: ${attributes.fontSize}`,
        }),
      },
    };
  },
});
```

### 7.2 公文段落扩展

```typescript
/**
 * 公文段落扩展
 * 支持首行缩进等公文段落格式
 */
const OfficialDocumentParagraph = Paragraph.extend({
  addAttributes() {
    return {
      ...this.parent?.(),
      textIndent: {
        default: '2em',
        parseHTML: element => element.style.textIndent,
        renderHTML: attributes => ({
          style: `text-indent: ${attributes.textIndent}`,
        }),
      },
      lineHeight: {
        default: '28pt',
        parseHTML: element => element.style.lineHeight,
        renderHTML: attributes => ({
          style: `line-height: ${attributes.lineHeight}`,
        }),
      },
      fontFamily: {
        default: '仿宋_GB2312',
        parseHTML: element => element.style.fontFamily,
        renderHTML: attributes => ({
          style: `font-family: ${attributes.fontFamily}`,
        }),
      },
      'data-ai-generated': {
        default: false,
        parseHTML: element => element.getAttribute('data-ai-generated') === 'true',
        renderHTML: attributes => {
          if (!attributes['data-ai-generated']) return {};
          return { 'data-ai-generated': 'true' };
        },
      },
    };
  },
});
```

### 7.3 落款区块扩展

```typescript
/**
 * 落款区块扩展
 * 用于公文末尾的签发单位和日期
 */
const SignatureBlock = Node.create({
  name: 'signatureBlock',
  group: 'block',
  content: 'signatureOrg signatureDate',

  parseHTML() {
    return [{ tag: 'div[data-type="signature-block"]' }];
  },

  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes(HTMLAttributes, {
      'data-type': 'signature-block',
      style: 'text-align: right; margin-top: 2em;',
    }), 0];
  },
});

const SignatureOrg = Node.create({
  name: 'signatureOrg',
  group: 'block',
  content: 'text*',

  renderHTML() {
    return ['p', { style: 'text-align: right; margin-bottom: 0.5em;' }, 0];
  },
});

const SignatureDate = Node.create({
  name: 'signatureDate',
  group: 'block',
  content: 'text*',

  renderHTML() {
    return ['p', { style: 'text-align: right;' }, 0];
  },
});
```

---

## 8. 状态管理设计

### 8.1 编辑器状态 (editorStore)

```typescript
/**
 * 编辑器 Zustand 状态
 */
interface EditorState {
  // 状态
  currentDocumentId: string | null;
  isDirty: boolean;
  wordCount: number;
  saveStatus: 'saved' | 'saving' | 'unsaved' | 'error';
  isAIGenerating: boolean;

  // 操作
  setCurrentDocument: (id: string) => void;
  setDirty: (dirty: boolean) => void;
  setWordCount: (count: number) => void;
  setSaveStatus: (status: EditorState['saveStatus']) => void;
  setAIGenerating: (generating: boolean) => void;
}

const useEditorStore = create<EditorState>((set) => ({
  currentDocumentId: null,
  isDirty: false,
  wordCount: 0,
  saveStatus: 'saved',
  isAIGenerating: false,

  setCurrentDocument: (id) => set({ currentDocumentId: id }),
  setDirty: (dirty) => set({ isDirty: dirty, saveStatus: dirty ? 'unsaved' : 'saved' }),
  setWordCount: (count) => set({ wordCount: count }),
  setSaveStatus: (status) => set({ saveStatus: status }),
  setAIGenerating: (generating) => set({ isAIGenerating: generating }),
}));
```

### 8.2 文档管理状态 (documentStore)

```typescript
/**
 * 文档管理 Zustand 状态
 */
interface DocumentStoreState {
  // 状态
  documents: DocumentData[];
  recentDocuments: DocumentData[];
  currentFilter: DocumentFilter;
  searchQuery: string;
  isLoading: boolean;

  // 操作
  loadDocuments: (filter?: DocumentFilter) => Promise<void>;
  loadRecentDocuments: () => Promise<void>;
  setFilter: (filter: DocumentFilter) => void;
  setSearchQuery: (query: string) => void;
  deleteDocument: (id: string) => Promise<void>;
}
```

---

## 9. 附录

### 9.1 预置模板清单

| 模板名称 | 类型代码 | 描述 | 内置 |
|----------|----------|------|------|
| 通知（标准） | notice | 标准通知格式 | 是 |
| 会议通知 | notice | 会议通知专用模板 | 是 |
| 工作报告 | report | 工作总结/汇报模板 | 是 |
| 调研报告 | report | 调研类报告模板 | 是 |
| 请示（标准） | request | 标准请示格式 | 是 |
| 批复（标准） | reply | 标准批复格式 | 是 |
| 函（标准） | letter | 标准函件格式 | 是 |
| 会议纪要 | minutes | 会议纪要模板 | 是 |

### 9.2 预置短语分类统计

| 分类 | 数量 | 示例 |
|------|------|------|
| 开头语 | 20+ | "为进一步..."、"根据...要求" |
| 结束语 | 15+ | "特此通知"、"请予以批准" |
| 过渡语 | 15+ | "综上所述"、"鉴于上述情况" |
| 请示用语 | 10+ | "当否，请批示"、"恳请批准" |
| 批复用语 | 10+ | "经研究，同意..."、"原则同意" |
| 通知用语 | 10+ | "现将有关事项通知如下" |

### 9.3 支持的图片素材格式

| 格式 | MIME类型 | 最大尺寸 |
|------|----------|----------|
| PNG | image/png | 10MB |
| JPG/JPEG | image/jpeg | 10MB |
| SVG | image/svg+xml | 5MB |

### 9.4 快捷键清单

| 快捷键 | 功能 |
|--------|------|
| Ctrl+S | 保存文档 |
| Ctrl+Z | 撤销 |
| Ctrl+Y | 重做 |
| Ctrl+G | AI生成内容 |
| Ctrl+Shift+R | AI改写选中内容 |
| Ctrl+/ | 打开素材快速搜索 |

---

*文档结束*
