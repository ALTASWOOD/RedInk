# 系统架构设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 文档状态 | 已完成 |
| 创建日期 | 2026-02-28 |
| 最后更新 | 2026-02-28 |

---

## 1. 架构概述

### 1.1 设计目标

RedInk 公文报告编写软件的架构设计遵循以下核心目标：

| 目标 | 说明 |
|------|------|
| 安全隔离 | 公网环境与私域环境严格隔离，确保敏感数据安全 |
| 灵活扩展 | 支持多种AI服务接入，便于扩展新的AI提供商 |
| 高性能 | 本地操作响应迅速，AI调用异步处理 |
| 跨平台 | 支持Windows、macOS、Linux主流操作系统 |
| 易维护 | 模块化设计，各层职责清晰，便于维护和升级 |

### 1.2 架构风格

采用 **分层架构 + 插件化设计** 的混合架构风格：

- **分层架构**：UI层、业务逻辑层、服务层、数据层清晰分离
- **插件化设计**：AI适配器、导出器、图表引擎等采用插件机制，支持动态扩展

---

## 2. 架构原则与约束

### 2.1 设计原则

| 原则 | 说明 |
|------|------|
| 单一职责 | 每个模块只负责单一功能，降低耦合度 |
| 开闭原则 | 对扩展开放，对修改关闭，通过接口抽象实现 |
| 依赖倒置 | 高层模块不依赖低层模块，都依赖抽象接口 |
| 安全优先 | 所有涉及数据传输的设计必须考虑安全性 |
| 离线优先 | 核心功能支持离线使用，AI功能可降级 |

### 2.2 技术约束

| 约束项 | 约束内容 |
|--------|----------|
| 客户端框架 | Electron  |
| 前端技术栈 | React 18+ / TypeScript 5+ |
| UI组件库 | Ant Design 5.x |
| 本地存储 | SQLite（通过 better-sqlite3 或 sql.js） |
| AI通信 | HTTP/HTTPS REST API |
| 文档处理 | docx.js (DOCX) / pdf-lib (PDF) |

---

## 3. 逻辑架构设计

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         表现层 (Presentation Layer)                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │  主界面     │ │  编辑器     │ │  AI助手面板  │ │  设置界面   │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    环境状态指示器 (公网蓝/私域绿)              │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        业务逻辑层 (Business Layer)                   │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐ │
│  │ 文档管理服务  │ │ 模板管理服务  │ │  审核服务    │ │ 导出服务   │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘ │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐ │
│  │ 图表生成服务  │ │ 环境管理服务  │ │  配置服务    │ │ 日志服务   │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         服务层 (Service Layer)                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    AI服务抽象层 (AI Abstraction)              │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐ │   │
│  │  │ OpenAI  │ │ Claude  │ │  通义   │ │ 文心    │ │ Ollama │ │   │
│  │  │ Adapter │ │ Adapter │ │ Adapter │ │ Adapter │ │ Adapter│ │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │  文档处理引擎 │ │  图表渲染引擎 │ │  格式转换引擎 │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          数据层 (Data Layer)                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐ │
│  │  文档存储    │ │  模板存储     │ │  配置存储    │ │  日志存储  │ │
│  │  (SQLite)   │ │  (文件系统)   │ │  (SQLite)   │ │  (文件)    │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 层次职责说明

| 层次 | 职责 | 关键组件 |
|------|------|----------|
| 表现层 | 用户界面展示、用户交互、环境状态显示 | React组件、状态管理、路由 |
| 业务逻辑层 | 业务规则处理、流程控制、服务编排 | 各业务Service |
| 服务层 | 外部服务对接、引擎封装、适配器管理 | AI适配器、文档引擎 |
| 数据层 | 数据持久化、缓存管理、文件操作 | SQLite、文件系统 |

---

## 4. 物理架构设计

### 4.1 部署架构

RedInk 采用桌面客户端架构，主要部署模式：

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户本地环境                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    RedInk 客户端                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │ │
│  │  │  主进程     │  │  渲染进程    │  │  本地数据存储   │   │ │
│  │  │  (Node.js) │  │  (Chromium) │  │  (SQLite/文件)  │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────────┐ │
│  │                    本地AI服务（可选）                       │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                Ollama / LM Studio                   │ │ │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │ │ │
│  │  │  │ Qwen-7B │  │ ChatGLM │  │ Llama2  │  ...       │ │ │
│  │  │  └─────────┘  └─────────┘  └─────────┘            │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┴─────────────────┐
            │ 公网环境时通过HTTPS访问            │
            ▼                                   ▼
┌─────────────────────┐           ┌─────────────────────┐
│    公网AI服务        │           │    公网AI服务        │
│  ┌───────────────┐  │           │  ┌───────────────┐  │
│  │   OpenAI API  │  │           │  │   通义千问API  │  │
│  └───────────────┘  │           │  └───────────────┘  │
│  ┌───────────────┐  │           │  ┌───────────────┐  │
│  │   Claude API  │  │           │  │   文心一言API  │  │
│  └───────────────┘  │           │  └───────────────┘  │
└─────────────────────┘           └─────────────────────┘
```

### 4.2 进程架构（Electron）

```
┌─────────────────────────────────────────────────────────────┐
│                        主进程 (Main Process)                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ 窗口管理    │ │ 文件系统操作 │ │ 系统API调用          │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ 数据库操作  │ │ 网络请求    │ │ 本地AI服务通信        │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                         IPC通信
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      渲染进程 (Renderer Process)             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    React 应用                        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ 页面组件 │ │ 状态管理 │ │ 路由系统 │ │ 主题系统 │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 技术选型

### 5.1 技术栈总览

| 类别 | 技术选型 | 版本要求 | 选型理由 |
|------|----------|----------|----------|
| 客户端框架 | Electron | 30.x | 生态成熟、跨平台、Node.js 全能力 |
| 前端框架 | React | 18.x | 生态完善、组件化、性能优秀 |
| 开发语言 | TypeScript | 5.x | 类型安全、开发效率高 |
| UI组件库 | Ant Design | 5.x | 企业级、功能丰富、主题定制 |
| 状态管理 | Zustand | 4.x | 轻量、简单、TypeScript友好 |
| 富文本编辑 | TipTap | 2.x | 可扩展、ProseMirror内核 |
| 本地数据库 | SQLite | 3.x | 轻量、无需安装、跨平台 |
| 文档生成 | docx.js | 8.x | 纯JS实现、功能完整 |
| PDF生成 | pdf-lib | 1.x | 轻量、纯JS、支持中文 |
| 图表绘制 | Mermaid + Excalidraw | - | 代码生成+手绘风格 |
| HTTP客户端 | Axios | 1.x | 功能完善、拦截器支持 |
| 构建工具 | Vite + electron-builder | - | 快速构建、完善的打包方案 |

### 5.2 AI服务SDK

| AI服务 | SDK/方式 | 说明 |
|--------|----------|------|
| OpenAI | openai-node | 官方SDK |
| Claude | @anthropic-ai/sdk | 官方SDK |
| 通义千问 | HTTP API | 阿里云API直接调用 |
| 文心一言 | HTTP API | 百度云API直接调用 |
| 讯飞星火 | HTTP API | WebSocket方式 |
| Ollama | HTTP API | 本地REST API |

### 5.3 技术选型决策记录

#### 决策1：客户端框架选择 Electron

| 对比项 | Electron | Tauri |
|--------|----------|-------|
| 安装包大小 | ~150MB | ~10MB |
| 内存占用 | 较高 | 较低 |
| 生态成熟度 | 非常成熟 | 成熟 |
| Node.js能力 | 完整支持 | 不支持 |
| 第三方库兼容 | 极好 | 受限 |
| 跨平台 | 支持 | 支持 |
| 开发效率 | 高（全JS/TS） | 中（需Rust） |

**决策**：选择 Electron，理由：
1. **生态成熟**：社区活跃，问题易解决，参考资料丰富
2. **Node.js 全能力**：可直接使用 better-sqlite3、fs 等 Node 原生模块
3. **开发效率高**：主进程和渲染进程均使用 TypeScript，无需学习 Rust
4. **第三方库兼容性好**：可无缝使用 npm 生态中的各类库

#### 决策2：状态管理选择 Zustand

| 对比项 | Redux | Zustand | MobX |
|--------|-------|---------|------|
| 学习成本 | 高 | 低 | 中 |
| 代码量 | 多 | 少 | 中 |
| TypeScript支持 | 好 | 很好 | 好 |
| 包大小 | 大 | 小 | 中 |

**决策**：选择 Zustand，理由是简单易用、TypeScript支持好、足够满足需求。

---

## 6. 核心模块设计

### 6.1 项目目录结构

项目采用 **Monorepo 单仓多包** 结构，清晰区分 Electron 主进程、前端渲染进程和后端服务层，便于分别维护和独立开发。

```
redink/
├── .vscode/                          # VS Code 配置
│   ├── extensions.json               # 推荐扩展
│   ├── settings.json                 # 工作区设置
│   └── launch.json                   # 调试配置
│
├── docs/                             # 项目文档
│   ├── 01 需求文档/
│   ├── 02 设计文档/
│   ├── 03 开发文档/
│   └── ...
│
├── public/                           # 静态资源（直接复制到构建目录）
│   ├── favicon.ico
│   └── fonts/
│
│
│ ═══════════════════════════════════════════════════════════════════
│                   Electron 主进程目录 (Main Process)
│ ═══════════════════════════════════════════════════════════════════
│
├── electron/                         # Electron 主进程 (Node.js + TypeScript)
│   │
│   ├── main/                         # 主进程入口
│   │   ├── index.ts                  # 主进程入口文件
│   │   ├── window.ts                 # 窗口管理
│   │   └── menu.ts                   # 菜单配置
│   │
│   ├── ipc/                          # IPC 通信处理
│   │   ├── index.ts                  # IPC 处理器注册
│   │   ├── document.ts               # 文档相关 IPC
│   │   ├── template.ts               # 模板相关 IPC
│   │   ├── file-system.ts            # 文件系统 IPC
│   │   ├── database.ts               # 数据库 IPC
│   │   ├── ai.ts                     # AI 服务 IPC
│   │   ├── export.ts                 # 导出 IPC
│   │   └── settings.ts               # 设置 IPC
│   │
│   ├── services/                     # 主进程业务服务
│   │   ├── index.ts                  # 服务统一导出
│   │   ├── document.service.ts       # 文档服务
│   │   ├── template.service.ts       # 模板服务
│   │   ├── export.service.ts         # 导出服务 (DOCX/PDF)
│   │   └── review.service.ts         # 审核服务
│   │
│   ├── ai/                           # AI 适配器层
│   │   ├── index.ts                  # AI 模块入口
│   │   ├── adapter.ts                # AI 适配器接口定义
│   │   ├── openai.adapter.ts         # OpenAI 适配器
│   │   ├── claude.adapter.ts         # Claude 适配器
│   │   ├── qwen.adapter.ts           # 通义千问适配器
│   │   ├── wenxin.adapter.ts         # 文心一言适配器
│   │   ├── ollama.adapter.ts         # Ollama 本地适配器
│   │   └── manager.ts                # AI 服务管理器
│   │
│   ├── database/                     # 数据库层
│   │   ├── index.ts                  # 数据库模块入口
│   │   ├── connection.ts             # 数据库连接管理 (better-sqlite3)
│   │   ├── models/                   # 数据模型
│   │   │   ├── index.ts
│   │   │   ├── document.model.ts     # 文档模型
│   │   │   ├── template.model.ts     # 模板模型
│   │   │   └── settings.model.ts     # 设置模型
│   │   └── repository/               # 数据仓库
│   │       ├── index.ts
│   │       ├── document.repo.ts      # 文档仓库
│   │       └── template.repo.ts      # 模板仓库
│   │
│   ├── utils/                        # 主进程工具模块
│   │   ├── index.ts
│   │   ├── crypto.ts                 # 加密工具
│   │   ├── file.ts                   # 文件工具
│   │   ├── logger.ts                 # 日志工具
│   │   └── path.ts                   # 路径工具
│   │
│   ├── config/                       # 配置模块
│   │   ├── index.ts
│   │   └── app.config.ts             # 应用配置
│   │
│   └── preload/                      # 预加载脚本
│       └── index.ts                  # 预加载脚本 (暴露安全 API 给渲染进程)
│
├── migrations/                       # 数据库迁移脚本
│   ├── 001_init.sql                  # 初始化表结构
│   ├── 002_templates.sql             # 模板表
│   └── 003_materials.sql             # 素材表
│
│
│ ═══════════════════════════════════════════════════════════════════
│                   前端渲染进程目录 (Renderer Process)
│ ═══════════════════════════════════════════════════════════════════
│
├── src/                              # 前端源码 (React + TypeScript)
│   │
│   ├── assets/                       # 静态资源
│   │   ├── images/                   # 图片资源
│   │   ├── icons/                    # 图标资源
│   │   └── templates/                # 公文模板文件
│   │
│   ├── components/                   # React 组件
│   │   ├── common/                   # 通用基础组件
│   │   │   ├── Button/
│   │   │   ├── Modal/
│   │   │   └── Loading/
│   │   ├── layout/                   # 布局组件
│   │   │   ├── MainLayout.tsx        # 主布局
│   │   │   ├── Sidebar.tsx           # 侧边栏
│   │   │   └── Header.tsx            # 顶部导航
│   │   ├── editor/                   # 编辑器相关组件
│   │   │   ├── EditorToolbar.tsx     # 编辑器工具栏
│   │   │   ├── TiptapEditor.tsx      # TipTap 编辑器封装
│   │   │   └── FormatPanel.tsx       # 格式面板
│   │   ├── ai/                       # AI 功能组件
│   │   │   ├── AIPanel.tsx           # AI 助手面板
│   │   │   ├── AIChat.tsx            # AI 对话组件
│   │   │   └── EnvironmentSwitch.tsx # 环境切换组件
│   │   ├── document/                 # 文档管理组件
│   │   │   ├── DocumentList.tsx      # 文档列表
│   │   │   ├── DocumentCard.tsx      # 文档卡片
│   │   │   └── TemplateSelector.tsx  # 模板选择器
│   │   └── chart/                    # 图表组件
│   │       ├── ChartEditor.tsx       # 图表编辑器
│   │       ├── FlowChart.tsx         # 流程图
│   │       └── MindMap.tsx           # 思维导图
│   │
│   ├── pages/                        # 页面组件
│   │   ├── HomePage.tsx              # 首页
│   │   ├── DocumentPage.tsx          # 文档编辑页
│   │   ├── DocumentListPage.tsx      # 文档列表页
│   │   ├── TemplatePage.tsx          # 模板管理页
│   │   ├── MaterialPage.tsx          # 素材库页
│   │   ├── AIAssistantPage.tsx       # AI 助手页
│   │   └── SettingsPage.tsx          # 设置页
│   │
│   ├── stores/                       # Zustand 状态管理
│   │   ├── index.ts                  # Store 统一导出
│   │   ├── envStore.ts               # 环境状态 (公网/私域)
│   │   ├── documentStore.ts          # 文档状态
│   │   ├── editorStore.ts            # 编辑器状态
│   │   ├── aiStore.ts                # AI 服务状态
│   │   └── settingsStore.ts          # 设置状态
│   │
│   ├── hooks/                        # 自定义 Hooks
│   │   ├── useAI.ts                  # AI 调用 Hook
│   │   ├── useDocument.ts            # 文档操作 Hook
│   │   ├── useEnvironment.ts         # 环境切换 Hook
│   │   ├── useExport.ts              # 导出功能 Hook
│   │   └── useIPC.ts                 # Electron IPC 封装 Hook
│   │
│   ├── services/                     # 前端服务层
│   │   ├── api/                      # API 调用封装
│   │   │   ├── index.ts              # API 统一导出
│   │   │   ├── document.ts           # 文档 API
│   │   │   ├── template.ts           # 模板 API
│   │   │   └── ai.ts                 # AI API
│   │   └── ipc/                      # Electron IPC 调用
│   │       ├── index.ts              # IPC 调用统一导出
│   │       ├── fileSystem.ts         # 文件系统 IPC
│   │       ├── database.ts           # 数据库 IPC
│   │       └── ai.ts                 # AI 服务 IPC
│   │
│   ├── types/                        # TypeScript 类型定义
│   │   ├── index.ts                  # 类型统一导出
│   │   ├── document.ts               # 文档相关类型
│   │   ├── template.ts               # 模板相关类型
│   │   ├── ai.ts                     # AI 相关类型
│   │   └── common.ts                 # 通用类型
│   │
│   ├── utils/                        # 工具函数
│   │   ├── format.ts                 # 格式化工具
│   │   ├── date.ts                   # 日期处理
│   │   ├── validation.ts             # 校验工具
│   │   └── storage.ts                # 本地存储工具
│   │
│   ├── styles/                       # 样式文件
│   │   ├── index.css                 # 全局样式入口
│   │   ├── variables.css             # CSS 变量定义
│   │   ├── theme/                    # 主题样式
│   │   │   ├── public.css            # 公网环境主题 (蓝色)
│   │   │   └── private.css           # 私域环境主题 (绿色)
│   │   └── components/               # 组件样式
│   │
│   ├── constants/                    # 常量定义
│   │   ├── index.ts                  # 常量统一导出
│   │   ├── document.ts               # 文档常量
│   │   ├── ai.ts                     # AI 配置常量
│   │   └── routes.ts                 # 路由常量
│   │
│   ├── router/                       # 路由配置
│   │   └── index.tsx                 # 路由定义
│   │
│   ├── App.tsx                       # 根组件
│   ├── main.tsx                      # 入口文件
│   └── vite-env.d.ts                 # Vite 类型声明
│
│
│ ═══════════════════════════════════════════════════════════════════
│                       后端服务层 (Backend Services)
│                       (可选，用于本地服务或未来扩展)
│ ═══════════════════════════════════════════════════════════════════
│
├── services/                         # 独立后端服务 (可选)
│   │
│   ├── knowledge-base/               # 知识库服务 (RAG)
│   │   ├── src/
│   │   │   ├── index.ts              # 服务入口
│   │   │   ├── embeddings.ts         # 向量嵌入
│   │   │   ├── retrieval.ts          # 检索服务
│   │   │   └── storage.ts            # 向量存储
│   │   ├── package.json
│   │   └── README.md
│   │
│   └── format-checker/               # 格式检查服务
│       ├── src/
│       │   ├── index.ts
│       │   ├── rules/                # 格式规则
│       │   └── checker.ts            # 检查器
│       ├── package.json
│       └── README.md
│
│
│ ═══════════════════════════════════════════════════════════════════
│                          配置与工程文件
│ ═══════════════════════════════════════════════════════════════════
│
├── package.json                      # 项目依赖配置
├── pnpm-lock.yaml                    # pnpm 依赖锁定
├── tsconfig.json                     # TypeScript 配置 (渲染进程)
├── tsconfig.electron.json            # TypeScript 配置 (主进程)
├── vite.config.ts                    # Vite 构建配置
├── electron-builder.json             # Electron 打包配置
├── tailwind.config.js                # Tailwind CSS 配置
├── postcss.config.js                 # PostCSS 配置
├── .eslintrc.cjs                     # ESLint 配置
├── .prettierrc                       # Prettier 配置
├── .gitignore                        # Git 忽略配置
├── .env.example                      # 环境变量模板
├── index.html                        # HTML 入口
└── README.md                         # 项目说明
```

### 6.2 目录职责说明

| 目录 | 层级 | 职责 | 技术栈 |
|------|------|------|--------|
| `electron/` | 主进程层 | 窗口管理、系统调用、文件操作、数据库、AI通信 | Node.js + TypeScript |
| `src/` | 渲染进程层 | UI 界面、用户交互、状态管理、路由 | React + TypeScript + Ant Design |
| `services/` | 后端服务层 | 独立微服务（知识库、格式检查等） | Node.js (可选) |
| `migrations/` | 数据层 | 数据库迁移脚本 | SQL |
| `public/` | 资源层 | 静态资源、字体、图标 | - |
| `docs/` | 文档层 | 项目文档、设计文档、API 文档 | Markdown |

### 6.3 前后端通信方式

```
┌─────────────────────────────────────────────────────────────────────┐
│                     渲染进程 (src/)                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  React Components → Hooks → Services → IPC Renderer         │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    Electron IPC (ipcRenderer.invoke)
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      主进程 (electron/)                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  IPC Handlers → Services → AI Adapters / Database / FS      │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    HTTP/HTTPS (公网) │ localhost (私域)
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         外部服务                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │
│  │ OpenAI   │  │ Claude   │  │ 通义千问  │  │ Ollama (本地)    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.4 关键文件说明

| 文件 | 说明 |
|------|------|
| `electron/main/index.ts` | Electron 主进程入口，创建窗口 |
| `electron/preload/index.ts` | 预加载脚本，安全暴露 API 给渲染进程 |
| `electron/ipc/index.ts` | IPC 处理器注册，主进程与渲染进程通信 |
| `electron/ai/adapter.ts` | AI 适配器接口定义，统一多 AI 服务 |
| `electron/ai/manager.ts` | AI 服务管理器，根据环境选择适配器 |
| `electron/database/connection.ts` | SQLite 数据库连接管理 (better-sqlite3) |
| `src/main.tsx` | 前端应用入口，初始化 React |
| `src/App.tsx` | React 根组件，配置路由和全局 Provider |
| `src/stores/envStore.ts` | 环境状态管理，控制公网/私域切换 |
| `vite.config.ts` | Vite 构建配置，路径别名、开发服务器 |
| `electron-builder.json` | Electron 打包配置，Windows/macOS/Linux |

### 6.5 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                           Pages                              │
│  (Home, Editor, Settings, TemplateManager)                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Components                           │
│  (Editor, AIPanel, ChartEditor, EnvironmentIndicator)        │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
┌─────────────────────────┐ ┌─────────────────────────┐
│        Stores           │ │        Hooks            │
│  (document, environment,│ │  (useAI, useDocument,   │
│   settings, ai)         │ │   useEnvironment)       │
└─────────────────────────┘ └─────────────────────────┘
                    │                   │
                    └─────────┬─────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Services                             │
│  (AIService, DocumentService, ExportService, ChartService)   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      IPC Bridge (Electron)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Main Process                            │
│  (Database, FileSystem, AIAdapter, NetworkRequest)           │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 关键流程设计

### 7.1 公文编写流程

```
用户                    渲染进程                    主进程                    AI服务
 │                         │                         │                         │
 │  1. 选择模板            │                         │                         │
 │ ───────────────────────>│                         │                         │
 │                         │  2. 获取模板内容         │                         │
 │                         │ ───────────────────────>│                         │
 │                         │  3. 返回模板             │                         │
 │                         │ <───────────────────────│                         │
 │  4. 显示编辑器          │                         │                         │
 │ <───────────────────────│                         │                         │
 │                         │                         │                         │
 │  5. 输入要点/请求AI生成  │                         │                         │
 │ ───────────────────────>│                         │                         │
 │                         │  6. 检查当前环境         │                         │
 │                         │ ───────────────────────>│                         │
 │                         │  7. 调用对应AI服务       │                         │
 │                         │                         │ ───────────────────────>│
 │                         │                         │  8. AI生成内容           │
 │                         │                         │ <───────────────────────│
 │                         │  9. 返回生成内容         │                         │
 │                         │ <───────────────────────│                         │
 │  10. 显示生成结果        │                         │                         │
 │ <───────────────────────│                         │                         │
 │                         │                         │                         │
 │  11. 编辑/保存          │                         │                         │
 │ ───────────────────────>│                         │                         │
 │                         │  12. 保存到本地数据库    │                         │
 │                         │ ───────────────────────>│                         │
```

### 7.2 环境切换流程

```
用户                    渲染进程                    主进程
 │                         │                         │
 │  1. 点击环境切换按钮     │                         │
 │ ───────────────────────>│                         │
 │                         │                         │
 │  2. 显示确认对话框       │                         │
 │     (私域→公网需警告)    │                         │
 │ <───────────────────────│                         │
 │                         │                         │
 │  3. 确认切换            │                         │
 │ ───────────────────────>│                         │
 │                         │  4. 更新环境配置         │
 │                         │ ───────────────────────>│
 │                         │                         │
 │                         │  5. 切换AI服务适配器     │
 │                         │ ───────────────────────>│
 │                         │                         │
 │                         │  6. 返回切换结果         │
 │                         │ <───────────────────────│
 │  7. 更新界面主题色       │                         │
 │ <───────────────────────│                         │
 │     (公网蓝/私域绿)      │                         │
```

---

## 8. 架构决策记录 (ADR)

### ADR-001: 采用分层架构

- **状态**：已采纳
- **背景**：需要一个清晰的代码组织方式
- **决策**：采用经典的分层架构（表现层、业务层、服务层、数据层）
- **后果**：代码结构清晰，各层职责明确，便于维护

### ADR-002: AI服务采用适配器模式

- **状态**：已采纳
- **背景**：需要支持多种AI服务，且未来可能增加新的AI提供商
- **决策**：定义统一的AI服务接口，各AI服务商实现各自的适配器
- **后果**：新增AI服务只需添加新适配器，不影响现有代码

### ADR-003: 本地存储采用SQLite

- **状态**：已采纳
- **背景**：需要持久化存储文档、配置等数据
- **决策**：使用SQLite作为本地数据库
- **后果**：无需额外安装数据库，单文件存储便于备份

### ADR-004: 环境隔离在架构层面实现

- **状态**：已采纳
- **背景**：公私隔离是核心特性，必须从架构层面保证
- **决策**：环境管理器作为独立模块，所有AI调用都必须经过环境检查
- **后果**：从架构上保证了公私环境的隔离

---

## 9. 附录

### 9.1 技术栈版本清单

```json
{
  "dependencies": {
    "electron": "^30.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "antd": "^5.12.0",
    "zustand": "^4.4.0",
    "@tiptap/react": "^2.1.0",
    "better-sqlite3": "^9.4.0",
    "docx": "^8.2.0",
    "pdf-lib": "^1.17.0",
    "axios": "^1.6.0",
    "mermaid": "^10.6.0"
  },
  "devDependencies": {
    "typescript": "^5.3.0",
    "vite": "^5.0.0",
    "electron-builder": "^24.0.0",
    "vite-plugin-electron": "^0.28.0",
    "@types/better-sqlite3": "^7.6.0"
  }
}
```

### 9.2 参考资料

- Electron官方文档: https://www.electronjs.org/docs
- React官方文档: https://react.dev/
- Ant Design官方文档: https://ant.design/
- electron-builder文档: https://www.electron.build/

---

*文档结束*
