# 单元测试规范

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-02-28 |

---

## 1. 测试框架

### 1.1 技术栈

| 工具 | 用途 |
|------|------|
| Vitest | 测试框架 |
| @testing-library/react | React组件测试 |
| msw | Mock API |

### 1.2 目录结构

```
src/
├── modules/
│   └── document/
│       ├── __tests__/
│       │   ├── documentService.test.ts
│       │   └── DocumentList.test.tsx
│       └── ...
└── shared/
    └── utils/
        └── __tests__/
            └── formatDate.test.ts
```

---

## 2. 编写规范

### 2.1 命名规范

```typescript
// 文件命名: [模块名].test.ts(x)
// 测试套件: describe('模块/函数名', ...)
// 测试用例: it('should 做什么 when 什么条件', ...)

describe('formatDate', () => {
  it('should return formatted date when valid date is provided', () => {
    expect(formatDate(new Date('2026-02-28'))).toBe('2026年02月28日');
  });

  it('should return empty string when date is null', () => {
    expect(formatDate(null)).toBe('');
  });
});
```

### 2.2 测试结构 (AAA模式)

```typescript
it('should update document when valid data is provided', async () => {
  // Arrange (准备)
  const doc = createMockDocument();
  const updates = { title: 'New Title' };
  
  // Act (执行)
  const result = await documentService.updateDocument(doc.id, updates);
  
  // Assert (断言)
  expect(result.title).toBe('New Title');
});
```

### 2.3 组件测试

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { DocumentList } from '../DocumentList';

describe('DocumentList', () => {
  it('should render document items', () => {
    const documents = [
      { id: '1', title: '文档1' },
      { id: '2', title: '文档2' },
    ];
    
    render(<DocumentList documents={documents} />);
    
    expect(screen.getByText('文档1')).toBeInTheDocument();
    expect(screen.getByText('文档2')).toBeInTheDocument();
  });

  it('should call onSelect when item is clicked', async () => {
    const onSelect = vi.fn();
    const documents = [{ id: '1', title: '文档1' }];
    
    render(<DocumentList documents={documents} onSelect={onSelect} />);
    
    fireEvent.click(screen.getByText('文档1'));
    
    expect(onSelect).toHaveBeenCalledWith('1');
  });
});
```

---

## 3. Mock 规范

### 3.1 Mock Tauri API

```typescript
// __mocks__/tauri.ts
vi.mock('@tauri-apps/api/core', () => ({
  invoke: vi.fn(),
}));

// 测试中使用
import { invoke } from '@tauri-apps/api/core';

beforeEach(() => {
  vi.mocked(invoke).mockResolvedValue({
    success: true,
    data: { document: mockDocument },
  });
});
```

### 3.2 Mock Store

```typescript
vi.mock('@/modules/document/stores/documentStore', () => ({
  useDocumentStore: vi.fn(() => ({
    documents: mockDocuments,
    isLoading: false,
    loadDocuments: vi.fn(),
  })),
}));
```

---

## 4. 覆盖率要求

| 模块 | 覆盖率要求 |
|------|------------|
| 工具函数 | ≥ 90% |
| Service | ≥ 80% |
| Store | ≥ 80% |
| 组件 | ≥ 70% |

---

## 5. 运行命令

```bash
# 运行所有测试
pnpm test

# 监听模式
pnpm test:watch

# 生成覆盖率报告
pnpm test:coverage

# 运行指定文件
pnpm test src/modules/document
```

---

*文档结束*
